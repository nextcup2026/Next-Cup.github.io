<!doctype html>
<html lang="it">

<head>
    <meta http-equiv="Content-Security-Policy"
        content="default-src 'self' https://*.firebaseio.com https://*.googleapis.com https://*.gstatic.com; script-src 'self' 'unsafe-inline' 'unsafe-eval' https://cdn.tailwindcss.com https://unpkg.com https://*.gstatic.com https://*.googleapis.com https://*.firebaseio.com; style-src 'self' 'unsafe-inline' https://fonts.googleapis.com; font-src 'self' https://fonts.gstatic.com; img-src 'self' data: https://* blob:; connect-src 'self' https://*.googleapis.com https://*.firebaseio.com https://*.gstatic.com https://identitytoolkit.googleapis.com;">
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>NEXT CUP - Pannello Admin (Firebase)</title>

    <!-- Favicon -->
    <link rel="icon" type="image/png" href="favicon.png">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #0d1a2f;
            color: #fff;
            min-height: 100vh;
        }

        #root {
            padding-top: 5rem;
            padding-bottom: 5rem;
        }

        .nx-text-gradient {
            background: -webkit-linear-gradient(45deg, #FFD700, #FBBF24, #3b82f6);
            background-clip: text;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .admin-section {
            background-color: #1f2937;
            padding: 2rem;
            border-radius: 1rem;
            margin-bottom: 2.5rem;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.5);
        }

        .loading-dot {
            width: 10px;
            height: 10px;
            background-color: #fcd34d;
            border-radius: 50%;
            display: inline-block;
            margin: 0 5px;
            animation: bounce 1.4s infinite ease-in-out both;
        }

        .loading-dot:nth-child(1) {
            animation-delay: -0.32s
        }

        .loading-dot:nth-child(2) {
            animation-delay: -0.16s
        }

        @keyframes bounce {

            0%,
            80%,
            100% {
                transform: scale(0)
            }

            40% {
                transform: scale(1.0)
            }
        }
    </style>
</head>

<body>
    <header class="fixed top-0 left-0 w-full z-50 bg-gray-900 bg-opacity-90 backdrop-blur-sm shadow-xl">
        <nav class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4 flex justify-between items-center">
            <div class="flex items-center space-x-2">
                <a href="admin.html" class="text-3xl font-black header-brand-text">NEXT CUP</a>
            </div>
            <div class="flex space-x-4 text-sm font-semibold">
                <a href="index.html" class="text-gray-300 hover:text-white transition">Home</a>
                <a href="torneo.html" class="text-gray-300 hover:text-white transition">Torneo</a>
                <a href="sondaggi.html" class="text-gray-300 hover:text-white transition">Sondaggi</a>
            </div>
        </nav>
    </header>

    <div id="root" class="max-w-6xl mx-auto px-4 sm:px-6 lg:px-8"></div>

    <div id="custom-alert-modal"
        class="hidden fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-[100]">
        <div class="bg-gray-800 p-6 rounded-xl shadow-2xl max-w-sm w-full">
            <h4 id="custom-alert-title" class="text-xl font-semibold mb-2"></h4>
            <p id="custom-alert-message" class="text-gray-300 mb-4"></p>
            <button id="custom-alert-close"
                class="w-full bg-indigo-600 text-white font-bold py-2 rounded-lg hover:bg-indigo-500 transition">Chiudi</button>
        </div>
    </div>

    <!-- CONFIG -->
    <script>
        window.__firebase_config = JSON.stringify({
            apiKey: "AIzaSyDKkaydSHxKT20XzWKfS16H1d6TMNq4p5Q",
            authDomain: "torneo-585ac.firebaseapp.com",
            projectId: "torneo-585ac",
            storageBucket: "torneo-585ac.firebasestorage.app",
            messagingSenderId: "79275251686",
            appId: "1:79275251686:web:15ca08ce46b6ce5e4fa827",
            measurementId: "G-S2NZJJXKWW"
        });

        // Metti qui la tua email admin esatta (solo lei potrÃ  accedere)
        window.__admin_allowed_emails = ["soscup2025@gmail.com"]; // <-- sostituisci con la tua email
        window.__admin_allowed_emails = ["nextcup2026@gmail.com"]; // <-- sostituisci con la tua email
        window.__initial_auth_token = null;
        window.__app_id = window.__app_id || "nextcup-app";
    </script>

    <!-- FIREBASE INIT -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import {
            getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut, setPersistence, browserLocalPersistence
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import {
            getFirestore, collection, doc, addDoc, setDoc, deleteDoc, getDoc,
            query, onSnapshot, getDocs, writeBatch, where, setLogLevel, increment,
            // NON serve piÃ¹ FieldValue, ma importiamo direttamente
            serverTimestamp as firebaseServerTimestamp // Rinominiamo per evitare conflitti, se necessario
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = (() => {
            try { return JSON.parse(window.__firebase_config ?? "{}"); } catch (e) { console.error(e); return {}; }
        })();

        if (!firebaseConfig || Object.keys(firebaseConfig).length === 0) {
            document.getElementById('root').innerHTML = `<div class="p-6 bg-red-700 rounded-lg text-white m-6"><h2 class="text-xl font-bold">ERRORE: Firebase Config mancante</h2></div>`;
            throw new Error("Firebase config mancante");
        }

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const baseAuth = getAuth(app);
        // setLogLevel('debug');

        const authWrapper = {
            signInWithEmailAndPassword: (email, pass) => signInWithEmailAndPassword(baseAuth, email, pass),
            signOut: () => signOut(baseAuth),
            onAuthStateChanged: (cb) => onAuthStateChanged(baseAuth, cb),
            setPersistence: () => setPersistence(baseAuth, browserLocalPersistence),
            getCurrentUser: () => baseAuth.currentUser ?? null
        };

        window.firebaseTools = {
            db,
            auth: authWrapper,
            appId: window.__app_id,

            // --- COLLEZIONI PRINCIPALI ---
            getTeamsCollectionRef: () => collection(db, `artifacts/${window.__app_id}/public/data/teams`),
            getResultsCollectionRef: () => collection(db, `artifacts/${window.__app_id}/public/data/results`),
            getNewsCollectionRef: () => collection(db, `artifacts/${window.__app_id}/public/data/news`),

            // --- CRUD TEAMS ---
            addTeam: (data) => addDoc(collection(db, `artifacts/${window.__app_id}/public/data/teams`), data),
            updateTeam: (id, data) => setDoc(doc(collection(db, `artifacts/${window.__app_id}/public/data/teams`), id), data, { merge: true }),
            deleteTeam: (id) => deleteDoc(doc(collection(db, `artifacts/${window.__app_id}/public/data/teams`), id)),

            // --- CRUD RESULTS ---
            addResult: (data) => addDoc(collection(db, `artifacts/${window.__app_id}/public/data/results`), data),
            deleteResult: (id) => deleteDoc(doc(collection(db, `artifacts/${window.__app_id}/public/data/results`), id)),

            // --- CRUD NEWS ---
            addNews: (data) => addDoc(collection(db, `artifacts/${window.__app_id}/public/data/news`), data),
            updateNews: (id, data) => setDoc(doc(collection(db, `artifacts/${window.__app_id}/public/data/news`), id), data, { merge: true }),
            deleteNews: (id) => deleteDoc(doc(collection(db, `artifacts/${window.__app_id}/public/data/news`), id)),

            // --- CRUD CALENDAR ---
            addScheduledMatch: (data) => addDoc(collection(db, `artifacts/${window.__app_id}/public/data/matches`), data),
            updateScheduledMatch: (id, data) => setDoc(doc(collection(db, `artifacts/${window.__app_id}/public/data/matches`), id), data, { merge: true }),
            deleteScheduledMatch: (id) => deleteDoc(doc(collection(db, `artifacts/${window.__app_id}/public/data/matches`), id)),

            // --- NEW: Delete Match AND Rollback Stats ---
            deleteMatchAndRollbackStats: async (matchId) => {
                const batch = writeBatch(db);
                const appId = window.__app_id;
                const matchRef = doc(db, `artifacts/${appId}/public/data/matches`, matchId);
                const matchSnap = await getDoc(matchRef);

                if (!matchSnap.exists()) throw new Error("Partita non trovata");

                const matchData = matchSnap.data();

                // If stats were counted, rollback them
                if (matchData.statsCounted === true && matchData.events && matchData.events.length > 0) {
                    const statsBase = `artifacts/${appId}/public/data`;
                    const getStatDoc = (collectionName, player, team) => {
                        const id = `${team.replace(/[^a-zA-Z0-9]/g, '_').toLowerCase()}_${player.replace(/[^a-zA-Z0-9]/g, '_').toLowerCase()}`;
                        return doc(db, `${statsBase}/${collectionName}`, id);
                    };

                    matchData.events.forEach(event => {
                        const { type, player, team } = event;
                        if (!player || !team) return;

                        if (type === 'goal') {
                            batch.set(getStatDoc('scorers', player, team), { goals: increment(-1) }, { merge: true });
                        } else if (type === 'assist') {
                            batch.set(getStatDoc('assists', player, team), { assists: increment(-1) }, { merge: true });
                        } else if (type === 'cleanSheet') {
                            batch.set(getStatDoc('cleanSheets', player, team), { cleanSheets: increment(-1) }, { merge: true });
                        } else if (type === 'yellow') {
                            batch.set(getStatDoc('cards', player, team), { yellow: increment(-1) }, { merge: true });
                        } else if (type === 'red') {
                            batch.set(getStatDoc('cards', player, team), { red: increment(-1) }, { merge: true });
                        }
                    });
                }

                // Delete the match document
                batch.delete(matchRef);

                await batch.commit();
            },

            onScheduledMatchesSnapshot: (cb) => onSnapshot(query(collection(db, `artifacts/${window.__app_id}/public/data/matches`)), (snap) => {
                // Sort by date/time (timestamp)
                const sorted = snap.docs.map(d => ({ id: d.id, ...d.data() })).sort((a, b) => (a.timestamp || '').localeCompare(b.timestamp || ''));
                cb(sorted);
            }),

            // --- CRUD POLLS ---
            addPoll: (data) => addDoc(collection(db, `artifacts/${window.__app_id}/public/data/polls`), data),
            deletePoll: (id) => deleteDoc(doc(collection(db, `artifacts/${window.__app_id}/public/data/polls`), id)),
            updatePoll: (id, data) => setDoc(doc(collection(db, `artifacts/${window.__app_id}/public/data/polls`), id), data, { merge: true }),
            onPollsSnapshot: (cb) => onSnapshot(query(collection(db, `artifacts/${window.__app_id}/public/data/polls`)), (snap) => {
                const sorted = snap.docs.map(d => ({ id: d.id, ...d.data() })).sort((a, b) => (b.timestamp || 0) - (a.timestamp || 0)); // Descending
                cb(sorted);
            }),

            // --- UTILS ---
            onSnapshot,
            serverTimestamp: firebaseServerTimestamp, // CORREZIONE QUI: usa la funzione importata direttamente

            // --- AZIONI COMPLESSE ---
            // --- AZIONI COMPLESSE ---
            resetAllResults: async () => {
                if (!confirm("ATTENZIONE: Stai per ELIMINARE TUTTO (Risultati, Partite in Calendario, Statistiche Giocatori). L'operazione Ã¨ irreversibile. Confermi?")) return;

                // STEP 1: Delete all RESULTS
                const qPoints = query(collection(db, `artifacts/${window.__app_id}/public/data/results`));
                const snapPoints = await getDocs(qPoints);
                const batch = writeBatch(db);
                snapPoints.docs.forEach(d => batch.delete(d.ref));

                // STEP 2: Delete all MATCHES (Calendar & Live)
                const qMatches = query(collection(db, `artifacts/${window.__app_id}/public/data/matches`));
                const snapMatches = await getDocs(qMatches);
                snapMatches.docs.forEach(d => batch.delete(d.ref));

                // STEP 3: Delete all STATS
                const statsBase = `artifacts/${window.__app_id}/public/data`;
                const statsCollections = ['scorers', 'assists', 'cleanSheets', 'cards', 'polls', 'news'];
                // Added polls/news optional, but sticking to match data mostly. Let's keep polls/news safe or ask? 
                // User said "reset di tutti i risultati, partite programmate e statistiche". So safe to keep news/polls?
                // Let's strictly follow request: results, matches, stats.
                const statCols = ['scorers', 'assists', 'cleanSheets', 'cards'];

                for (const colName of statCols) {
                    const sSnap = await getDocs(collection(db, `${statsBase}/${colName}`));
                    sSnap.docs.forEach(d => batch.delete(d.ref));
                }

                await batch.commit();
                alert("Reset completato: Risultati, Calendario e Statistiche eliminati.");
                window.location.reload();
            },
            increment: increment,
            getDoc: getDoc, // Espongo getDoc

            // --- QUESTE FUNZIONI CRUD BASE RIMANGONO, MA PER I RISULTATI useremo logica custom nel componente ---
            // addResult: ... (lo faremo custom con batch)
            deleteResultString: (id) => deleteDoc(doc(collection(db, `artifacts/${window.__app_id}/public/data/results`), id)), // rinomino per chiarezza, useremo una custom

            deleteResultsByTeamName: async (teamName) => {
                const batch = writeBatch(db);
                const appId = window.__app_id;

                // 1. Delete Results
                const resultsRef = collection(db, `artifacts/${appId}/public/data/results`);
                const q1 = query(resultsRef, where("team1", "==", teamName));
                const q2 = query(resultsRef, where("team2", "==", teamName));
                const [s1, s2] = await Promise.all([getDocs(q1), getDocs(q2)]);

                s1.docs.forEach(d => batch.delete(d.ref));
                s2.docs.forEach(d => batch.delete(d.ref));

                // 2. Delete Player Stats for this team
                const statsBase = `artifacts/${appId}/public/data`;
                const statsCollections = ['scorers', 'assists', 'cleanSheets', 'cards'];

                for (const colName of statsCollections) {
                    const q = query(collection(db, `${statsBase}/${colName}`), where("team", "==", teamName));
                    const snap = await getDocs(q);
                    snap.docs.forEach(d => batch.delete(d.ref));
                }

                await batch.commit();
            },

            addResultWithStats: async (resultData, matchEvents) => {
                const batch = writeBatch(db);
                const appId = window.__app_id;

                // 1. Create Result Document
                const resultsRef = collection(db, `artifacts/${appId}/public/data/results`);
                const newResultRef = doc(resultsRef);
                batch.set(newResultRef, { ...resultData, stats: matchEvents });

                // 2. Update Stats
                const statsBase = `artifacts/${appId}/public/data`;

                // Helper to get doc ref (Sanitize IDs)
                const getStatDoc = (collectionName, player, team) => {
                    const id = `${team.replace(/[^a-zA-Z0-9]/g, '_').toLowerCase()}_${player.replace(/[^a-zA-Z0-9]/g, '_').toLowerCase()}`;
                    return doc(db, `${statsBase}/${collectionName}`, id);
                };

                matchEvents.forEach(event => {
                    const { type, player, team } = event;
                    if (!player || !team) return;

                    if (type === 'goal') {
                        const ref = getStatDoc('scorers', player, team);
                        batch.set(ref, { name: player, team: team, goals: increment(1) }, { merge: true });
                    } else if (type === 'assist') {
                        const ref = getStatDoc('assists', player, team);
                        batch.set(ref, { name: player, team: team, assists: increment(1) }, { merge: true });
                    } else if (type === 'cleanSheet') {
                        const ref = getStatDoc('cleanSheets', player, team);
                        batch.set(ref, { name: player, team: team, cleanSheets: increment(1) }, { merge: true });
                    } else if (type === 'yellow') {
                        const ref = getStatDoc('cards', player, team);
                        batch.set(ref, { name: player, team: team, yellow: increment(1) }, { merge: true });
                    } else if (type === 'red') {
                        const ref = getStatDoc('cards', player, team);
                        batch.set(ref, { name: player, team: team, red: increment(1), yellow: increment(0) }, { merge: true }); // Ensure yellow field exists
                    }
                });

                await batch.commit();
            },

            deleteResultWithStats: async (resultId) => {
                const batch = writeBatch(db);
                const appId = window.__app_id;
                const resultRef = doc(db, `artifacts/${appId}/public/data/results`, resultId);

                // 1. Get the result to know what stats to rollback
                const snap = await getDoc(resultRef);
                if (!snap.exists()) throw new Error("Risultato non trovato");
                const data = snap.data();
                const matchEvents = data.stats || [];

                // 2. Delete Result
                batch.delete(resultRef);

                // 3. Rollback Stats
                const statsBase = `artifacts/${appId}/public/data`;
                const getStatDoc = (collectionName, player, team) => {
                    const id = `${team.replace(/[^a-zA-Z0-9]/g, '_').toLowerCase()}_${player.replace(/[^a-zA-Z0-9]/g, '_').toLowerCase()}`;
                    return doc(db, `${statsBase}/${collectionName}`, id);
                };

                matchEvents.forEach(event => {
                    const { type, player, team } = event;
                    if (!player || !team) return;

                    if (type === 'goal') {
                        const ref = getStatDoc('scorers', player, team);
                        batch.set(ref, { goals: increment(-1) }, { merge: true });
                    } else if (type === 'assist') {
                        const ref = getStatDoc('assists', player, team);
                        batch.set(ref, { assists: increment(-1) }, { merge: true });
                    } else if (type === 'cleanSheet') {
                        const ref = getStatDoc('cleanSheets', player, team);
                        batch.set(ref, { cleanSheets: increment(-1) }, { merge: true });
                    } else if (type === 'yellow') {
                        const ref = getStatDoc('cards', player, team);
                        batch.set(ref, { yellow: increment(-1) }, { merge: true });
                    } else if (type === 'red') {
                        const ref = getStatDoc('cards', player, team);
                        batch.set(ref, { red: increment(-1) }, { merge: true });
                    }
                });

                await batch.commit();
            },

            // --- NUOVA FUNZIONE UNIFICATA PER MATCHES ---
            finalizeMatchWithStats: async (matchId, matchData, matchEvents) => {
                const batch = writeBatch(db);
                const appId = window.__app_id;
                const matchRef = doc(db, `artifacts/${appId}/public/data/matches`, matchId);
                const matchSnap = await getDoc(matchRef);

                const statsBase = `artifacts/${appId}/public/data`;
                const getStatDoc = (collectionName, player, team) => {
                    const id = `${team.replace(/[^a-zA-Z0-9]/g, '_').toLowerCase()}_${player.replace(/[^a-zA-Z0-9]/g, '_').toLowerCase()}`;
                    return doc(db, `${statsBase}/${collectionName}`, id);
                };

                console.log("FINALIZING MATCH:", matchId);
                console.log("EVENTS TO PROCESS:", matchEvents);
                console.log("Is increment function defined?", typeof increment);

                // ROLLBACK LOGIC: If stats were already counted, reverse them first.
                if (matchSnap.exists() && matchSnap.data().statsCounted === true) {
                    const oldEvents = matchSnap.data().events || [];
                    oldEvents.forEach(event => {
                        const { type, player, team } = event;
                        if (!player || !team) return;
                        if (type === 'goal') {
                            batch.set(getStatDoc('scorers', player, team), { goals: increment(-1) }, { merge: true });
                        } else if (type === 'assist') {
                            batch.set(getStatDoc('assists', player, team), { assists: increment(-1) }, { merge: true });
                        } else if (type === 'cleanSheet') {
                            batch.set(getStatDoc('cleanSheets', player, team), { cleanSheets: increment(-1) }, { merge: true });
                        } else if (type === 'yellow') {
                            batch.set(getStatDoc('cards', player, team), { yellow: increment(-1) }, { merge: true });
                        } else if (type === 'red') {
                            batch.set(getStatDoc('cards', player, team), { red: increment(-1) }, { merge: true });
                        }
                    });
                }

                // 1. Update Match Document (Set statsCounted = true)
                batch.set(matchRef, { ...matchData, events: matchEvents, statsCounted: true }, { merge: true });

                // 2. APPLY NEW STATS
                matchEvents.forEach(event => {
                    const { type, player, team } = event;
                    if (!player || !team) return;

                    if (type === 'goal') {
                        const ref = getStatDoc('scorers', player, team);
                        batch.set(ref, { name: player, team: team, goals: increment(1) }, { merge: true });
                    } else if (type === 'assist') {
                        const ref = getStatDoc('assists', player, team);
                        batch.set(ref, { name: player, team: team, assists: increment(1) }, { merge: true });
                    } else if (type === 'cleanSheet') {
                        const ref = getStatDoc('cleanSheets', player, team);
                        batch.set(ref, { name: player, team: team, cleanSheets: increment(1) }, { merge: true });
                    } else if (type === 'yellow') {
                        const ref = getStatDoc('cards', player, team);
                        batch.set(ref, { name: player, team: team, yellow: increment(1) }, { merge: true });
                    } else if (type === 'red') {
                        const ref = getStatDoc('cards', player, team);
                        // Ensure yellow is initialized to 0 if we set red, to avoid undefined yellow
                        batch.set(ref, { name: player, team: team, red: increment(1), yellow: increment(0) }, { merge: true });
                    }
                });

                await batch.commit();
            }
        };

        document.getElementById('custom-alert-close')?.addEventListener('click', () => {
            document.getElementById('custom-alert-modal')?.classList.add('hidden');
        });

        console.log("Firebase inizializzato e window.firebaseTools pronto (incluso News)");
    </script>
    <!-- REACT APP (completa) -->
    <script type="text/babel">
        const { useState, useEffect, useCallback, useMemo } = React;

        const showCustomModal = (title, message, type = 'info') => {
            const modal = document.getElementById('custom-alert-modal');
            const t = document.getElementById('custom-alert-title');
            const m = document.getElementById('custom-alert-message');
            t.textContent = title;
            m.textContent = message;
            t.className = "text-xl font-semibold mb-2 " + (type === 'error' ? 'text-red-500' : (type === 'success' ? 'text-green-500' : 'text-yellow-500'));
            modal.classList.remove('hidden');
        };

        const ConfirmationModal = ({ isVisible, title, message, onConfirm, onCancel }) => {
            if (!isVisible) return null;
            return (
                <div className="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50 p-4" onClick={onCancel}>
                    <div className="bg-gray-900 p-8 rounded-xl shadow-2xl max-w-lg w-full border border-red-500" onClick={(e) => e.stopPropagation()}>
                        <h4 className="text-2xl font-bold text-red-500 mb-4">{title}</h4>
                        <p className="text-gray-300 mb-6">{message}</p>
                        <div className="flex justify-end space-x-4">
                            <button onClick={onCancel} className="bg-gray-700 text-white px-4 py-2 rounded-lg hover:bg-gray-600">Annulla</button>
                            <button onClick={onConfirm} className="bg-red-600 text-white px-4 py-2 rounded-lg hover:bg-red-500">Conferma</button>
                        </div>
                    </div>
                </div>
            );
        };

        const SystemAlert = ({ isVisible, title, message, type, onClose }) => {
            if (!isVisible) return null;
            const base = "fixed top-4 right-4 p-4 rounded-lg shadow-xl z-50 max-w-sm transition-all duration-300 transform";
            let color = "bg-yellow-100 border border-yellow-400 text-yellow-700";
            if (type === 'error') color = "bg-red-100 border border-red-400 text-red-700";
            if (type === 'success') color = "bg-green-100 border border-green-400 text-green-700";
            return (
                <div className={`${base} ${color}`} role="alert">
                    <div className="flex justify-between items-start">
                        <div>
                            <strong className="font-bold">{title}</strong>
                            <p className="block sm:inline mt-1 text-sm">{message}</p>
                        </div>
                        <button onClick={onClose} className={`ml-4 ${type === 'error' ? 'text-red-500' : 'text-gray-700'} hover:opacity-75`}>
                            <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                        </button>
                    </div>
                </div>
            );
        };

        const styles = {
            input: "mt-1 block w-full px-3 py-2 bg-gray-700 text-white border border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-yellow-500 focus:border-yellow-500",
        };

        // NEW Component for Player Stats
        const PlayerStatSelector = ({ team, teamName, onAddEvent }) => {
            const players = team?.players || [];
            const [minute, setMinute] = useState('');

            if (players.length === 0) return <p className="text-gray-500 text-sm">Nessun giocatore.</p>;
            return (
                <div className="bg-gray-800 p-3 rounded-lg mb-2 border border-gray-700">
                    <div className="flex justify-between items-center mb-2 border-b border-gray-700 pb-1">
                        <h5 className="font-bold text-gray-300">{teamName}</h5>
                        <div className="flex items-center space-x-2">
                            <span className="text-xs text-gray-400">Min:</span>
                            <input
                                type="number"
                                min="1"
                                max="120"
                                value={minute}
                                onChange={(e) => setMinute(e.target.value)}
                                className="w-12 bg-gray-900 border border-gray-600 text-white text-xs rounded px-1 py-0.5 text-center focus:border-yellow-500 outline-none"
                                placeholder="'"
                            />
                        </div>
                    </div>
                    {players.map((p, i) => {
                        const pName = typeof p === 'object' ? p.name : p;
                        return (
                            <div key={i} className="flex justify-between items-center py-1 border-b border-gray-700 last:border-0 hover:bg-gray-750">
                                <span className="text-sm truncate w-24 mr-2 text-gray-200" title={pName}>{pName}</span>
                                <div className="flex space-x-1">
                                    <button onClick={() => onAddEvent('goal', pName, teamName, minute)} className="text-xs bg-yellow-600 hover:bg-yellow-500 text-white px-2 py-1 rounded" title="Gol">âš½</button>
                                    <button onClick={() => onAddEvent('assist', pName, teamName, minute)} className="text-xs bg-blue-600 hover:bg-blue-500 text-white px-2 py-1 rounded" title="Assist">ðŸŽ¯</button>
                                    <button onClick={() => onAddEvent('cleanSheet', pName, teamName, minute)} className="text-xs bg-green-600 hover:bg-green-500 text-white px-2 py-1 rounded" title="Clean Sheet">ðŸ§¤</button>
                                    <button onClick={() => onAddEvent('yellow', pName, teamName, minute)} className="text-xs bg-yellow-400 hover:bg-yellow-300 text-black px-2 py-1 rounded" title="Giallo">ðŸŸ¨</button>
                                    <button onClick={() => onAddEvent('red', pName, teamName, minute)} className="text-xs bg-red-600 hover:bg-red-500 text-white px-2 py-1 rounded" title="Rosso">ðŸŸ¥</button>
                                </div>
                            </div>
                        );
                    })}
                </div>
            );
        };

        // MatchScheduler (Calendar & Live & Standings)
        const MatchScheduler = ({ authReady, teams, currentResults, showMessage, firebaseTools }) => {
            const [date, setDate] = useState('');
            const [time, setTime] = useState('');
            const [team1, setTeam1] = useState('');
            const [team2, setTeam2] = useState('');
            const [stage, setStage] = useState('Girone A');
            const [scheduledMatches, setScheduledMatches] = useState([]);
            const [isSaving, setIsSaving] = useState(false);

            // Live Management State
            const [managingMatch, setManagingMatch] = useState(null);
            const [liveScore1, setLiveScore1] = useState(0);
            const [liveScore2, setLiveScore2] = useState(0);
            const [liveStatus, setLiveStatus] = useState('SCHEDULED');
            const [matchEvents, setMatchEvents] = useState([]);

            // Legacy Results Logic (from ResultsManager) for Standings
            const [legacyResults, setLegacyResults] = useState([]); // This will come from props 'currentResults'

            useEffect(() => {
                const unsubscribe = firebaseTools.onScheduledMatchesSnapshot(setScheduledMatches);
                return () => unsubscribe();
            }, []);

            // CALCULATE STANDINGS
            const standings = useMemo(() => {
                const map = (teams || []).reduce((acc, team) => ({ ...acc, [team.name]: { name: team.name, played: 0, wins: 0, draws: 0, losses: 0, goalsFor: 0, goalsAgainst: 0, points: 0 } }), {});

                const processGame = (team1, team2, s1, s2) => {
                    const score1 = parseInt(s1);
                    const score2 = parseInt(s2);
                    if (isNaN(score1) || isNaN(score2)) return;

                    if (map[team1] && map[team2]) {
                        map[team1].played += 1;
                        map[team2].played += 1;
                        map[team1].goalsFor += score1;
                        map[team1].goalsAgainst += score2;
                        map[team2].goalsFor += score2;
                        map[team2].goalsAgainst += score1;

                        if (score1 > score2) { map[team1].wins += 1; map[team2].losses += 1; map[team1].points += 3; }
                        else if (score1 < score2) { map[team2].wins += 1; map[team1].losses += 1; map[team2].points += 3; }
                        else { map[team1].draws += 1; map[team2].draws += 1; map[team1].points += 1; map[team2].points += 1; }
                    }
                };

                // Process Legacy Results (passed via props as currentResults)
                (currentResults || []).forEach(r => processGame(r.team1, r.team2, r.score1, r.score2));

                // Process Finished Matches
                scheduledMatches.forEach(m => {
                    if (m.status === 'FINISHED' && m.stage && m.stage.startsWith('Girone')) processGame(m.team1, m.team2, m.score1, m.score2);
                });

                return Object.values(map).filter(team => (teams || []).some(t => t.name === team.name)).sort((a, b) => {
                    if (b.points !== a.points) return b.points - a.points;
                    const diffA = a.goalsFor - a.goalsAgainst;
                    const diffB = b.goalsFor - b.goalsAgainst;
                    if (diffB !== diffA) return diffB - diffA;
                    return b.goalsFor - a.goalsFor;
                });
            }, [teams, currentResults, scheduledMatches]);

            // Open Live Manager
            const openLiveManager = (match) => {
                setManagingMatch(match);
                setLiveScore1(match.score1 || 0);
                setLiveScore2(match.score2 || 0);
                setLiveStatus(match.status || 'SCHEDULED'); // SCHEDULED, LIVE, FINISHED
                let loadedEvents = match.events || [];

                setMatchEvents(loadedEvents);
            };

            const closeLiveManager = () => {
                setManagingMatch(null);
            };

            const handleSchedule = async () => {
                if (!authReady || !date || !time || !team1 || !team2) return showMessage('Compila tutti i campi', 'error');
                if (team1 === team2) return showMessage('Le squadre devono essere diverse', 'error');

                setIsSaving(true);
                try {
                    await firebaseTools.addScheduledMatch({
                        date, time, team1, team2, stage,
                        timestamp: new Date(`${date}T${time}`).toISOString(),
                        status: 'SCHEDULED', score1: 0, score2: 0, events: []
                    });
                    showMessage('Partita programmata!', 'success');
                    setDate(''); setTime(''); setTeam1(''); setTeam2('');
                } catch (e) {
                    showMessage('Errore: ' + e.message, 'error');
                }
                setIsSaving(false);
            };

            const handleDelete = async (id) => {
                if (!confirm('Eliminare partita programmata? Se la partita era conclusa, le statistiche verranno rimosse dalle classifiche.')) return;
                try {
                    await firebaseTools.deleteMatchAndRollbackStats(id);
                    showMessage('Partita eliminata e statistiche aggiornate', 'success');
                } catch (e) {
                    showMessage('Errore eliminazione', 'error');
                }
            };

            // LIVE UPDATES
            const saveLiveUpdate = async () => {
                if (!managingMatch) return;
                try {
                    await firebaseTools.updateScheduledMatch(managingMatch.id, {
                        score1: parseInt(liveScore1),
                        score2: parseInt(liveScore2),
                        status: liveStatus,
                        events: matchEvents
                    });
                    showMessage('Aggiornamento Live salvato!', 'success');
                } catch (e) {
                    showMessage('Errore update live: ' + e.message, 'error');
                }
            };

            const handleFinalizeMatch = async () => {
                if (!managingMatch) return;
                if (!confirm("Sei sicuro di voler CONCLUDERE la partita? VerrÃ  impostata come FINITA e le statistiche globali (classifica, marcatori, ecc.) verranno aggiornate. Questa azione dovrebbe essere fatta una volta sola.")) return;

                try {
                    await firebaseTools.finalizeMatchWithStats(managingMatch.id, {
                        score1: parseInt(liveScore1),
                        score2: parseInt(liveScore2),
                        status: 'FINISHED'
                    }, matchEvents);
                    showMessage('Partita Conclusa e Classifiche Aggiornate!', 'success');
                    setLiveStatus('FINISHED');
                    closeLiveManager();
                } catch (e) {
                    showMessage('Errore finalizzazione: ' + e.message, 'error');
                }
            };

            const addEvent = (type, player, team, minute) => {
                setMatchEvents(prev => [...prev, { type, player, team, minute: minute || '', id: Date.now() + Math.random() }]);
            };

            const removeEvent = (id) => {
                setMatchEvents(prev => prev.filter(e => e.id !== id));
            };

            // Helper to get team objects
            const team1Obj = teams.find(t => t.name === managingMatch?.team1);
            const team2Obj = teams.find(t => t.name === managingMatch?.team2);

            return (
                <div className="admin-section border-l-8 border-purple-500">
                    <h3 className="text-4xl font-bold text-purple-400 mb-6">Gestione Torneo & Live (Unificato)</h3>

                    {!managingMatch ? (
                        <>
                            {/* CLASSIFICA TABELLA INCLUSA QUI */}
                            <div className="mb-8 p-6 bg-gray-900 rounded-lg border border-yellow-500/50">
                                <h4 className="text-2xl font-semibold text-yellow-400 mb-4">Classifica Unificata</h4>
                                <div className="overflow-x-auto">
                                    <table className="min-w-full divide-y divide-gray-700 text-sm">
                                        <thead>
                                            <tr>
                                                <th className="p-2 text-left text-gray-400">#</th>
                                                <th className="p-2 text-left text-gray-400">Squadra</th>
                                                <th className="p-2 text-gray-400">G</th>
                                                <th className="p-2 text-gray-400">V</th>
                                                <th className="p-2 text-gray-400">N</th>
                                                <th className="p-2 text-gray-400">P</th>
                                                <th className="p-2 text-gray-400">GF</th>
                                                <th className="p-2 text-gray-400">GS</th>
                                                <th className="p-2 text-gray-400">DR</th>
                                                <th className="p-2 text-gray-400">Pt</th>
                                            </tr>
                                        </thead>
                                        <tbody className="divide-y divide-gray-800">
                                            {standings.map((team, index) => (
                                                <tr key={team.name} className="hover:bg-gray-800">
                                                    <td className="p-2 font-bold text-yellow-400">{index + 1}</td>
                                                    <td className="p-2 font-medium text-white">{team.name}</td>
                                                    <td className="p-2 text-center">{team.played}</td>
                                                    <td className="p-2 text-center">{team.wins}</td>
                                                    <td className="p-2 text-center">{team.draws}</td>
                                                    <td className="p-2 text-center">{team.losses}</td>
                                                    <td className="p-2 text-center">{team.goalsFor}</td>
                                                    <td className="p-2 text-center">{team.goalsAgainst}</td>
                                                    <td className="p-2 text-center font-semibold">{team.goalsFor - team.goalsAgainst}</td>
                                                    <td className="p-2 text-center font-extrabold text-lg text-indigo-400">{team.points}</td>
                                                </tr>
                                            ))}
                                            {standings.length === 0 && <tr><td colSpan="10" className="text-center p-4 text-gray-500">Nessuna squadra o risultato.</td></tr>}
                                        </tbody>
                                    </table>
                                </div>
                            </div>

                            {/* FORM PROGRAMMAZIONE */}
                            <div className="mb-8 p-6 bg-gray-900 rounded-lg border border-purple-500/50">
                                <h4 className="text-xl font-semibold mb-4 text-white">Programma Nuova Partita</h4>
                                <div className="grid grid-cols-1 md:grid-cols-5 gap-4">
                                    <input type="date" value={date} onChange={e => setDate(e.target.value)} className={styles.input} />
                                    <input type="time" value={time} onChange={e => setTime(e.target.value)} className={styles.input} />
                                    <select value={team1} onChange={e => setTeam1(e.target.value)} className={styles.input}>
                                        <option value="">Squadra 1</option>
                                        {teams.map(t => <option key={t.id} value={t.name}>{t.name}</option>)}
                                    </select>
                                    <select value={team2} onChange={e => setTeam2(e.target.value)} className={styles.input}>
                                        <option value="">Squadra 2</option>
                                        {teams.map(t => <option key={t.id} value={t.name}>{t.name}</option>)}
                                    </select>
                                    <select value={stage} onChange={e => setStage(e.target.value)} className={styles.input}>
                                        <option value="Girone A">Girone A</option>
                                        <option value="Girone B">Girone B</option>
                                        <option value="Girone C">Girone C</option>
                                        <option value="Girone D">Girone D</option>
                                        <option value="Ottavi">Ottavi</option>
                                        <option value="Quarti">Quarti</option>
                                        <option value="Semifinale">Semifinale</option>
                                        <option value="Finale">Finale</option>
                                    </select>
                                </div>
                                <button onClick={handleSchedule} disabled={isSaving} className="mt-4 w-full bg-purple-600 hover:bg-purple-500 text-white font-bold py-3 rounded transition">
                                    {isSaving ? 'Salvataggio...' : 'Programma Partita'}
                                </button>
                            </div>

                            {/* LISTA PARTITE */}
                            <div className="space-y-4">
                                {scheduledMatches.map(m => (
                                    <div key={m.id} className="bg-gray-800 p-4 rounded flex justify-between items-center border border-gray-700">
                                        <div>
                                            <div className="flex items-center space-x-2">
                                                <span className="text-purple-400 font-bold block">{m.date} {m.time} - {m.stage}</span>
                                                {m.status === 'LIVE' && <span className="bg-green-500 text-black text-xs font-bold px-2 py-0.5 rounded animate-pulse">LIVE</span>}
                                                {m.status === 'FINISHED' && <span className="bg-gray-600 text-white text-xs font-bold px-2 py-0.5 rounded">FINITO</span>}
                                            </div>
                                            <span className="text-xl text-white font-semibold">{m.team1} <span className="text-yellow-400">{m.score1 || 0}</span> - <span className="text-yellow-400">{m.score2 || 0}</span> {m.team2}</span>
                                        </div>
                                        <div className="flex space-x-3">
                                            <button onClick={() => openLiveManager(m)} className="bg-green-600 text-white px-3 py-1 rounded hover:bg-green-500 text-sm font-bold">Gestisci Live/Risultato</button>
                                            <button onClick={() => handleDelete(m.id)} className="text-red-500 hover:text-red-400 text-sm">Elimina</button>
                                        </div>
                                    </div>
                                ))}
                            </div>
                        </>
                    ) : (
                        /* LIVE MANAGER PANEL */
                        <div className="bg-gray-900 p-6 rounded-xl border-2 border-green-500 shadow-2xl animate-fade-in">
                            <div className="flex justify-between items-center mb-6 border-b border-gray-700 pb-4">
                                <h4 className="text-2xl font-bold text-white">Gestione Live: <span className="text-yellow-400">{managingMatch.team1} vs {managingMatch.team2}</span></h4>
                                <button onClick={closeLiveManager} className="text-gray-400 hover:text-white">Chiudi X</button>
                            </div>

                            <div className="grid grid-cols-1 md:grid-cols-2 gap-8">
                                {/* STATO & PUNTEGGIO */}
                                <div>
                                    <label className="block text-sm text-gray-400 mb-2">Stato Partita</label>
                                    <div className="flex space-x-2 mb-6">
                                        {['SCHEDULED', 'LIVE', 'FINISHED'].map(s => (
                                            <button key={s}
                                                onClick={() => setLiveStatus(s)}
                                                className={`px-4 py-2 rounded font-bold ${liveStatus === s
                                                    ? (s === 'LIVE' ? 'bg-green-500 text-black' : (s === 'FINISHED' ? 'bg-red-500 text-white' : 'bg-blue-500 text-white'))
                                                    : 'bg-gray-700 text-gray-400'
                                                    }`}
                                            >
                                                {s}
                                            </button>
                                        ))}
                                    </div>

                                    <label className="block text-sm text-gray-400 mb-2">Punteggio</label>
                                    <div className="flex items-center space-x-6 mb-6">
                                        <div className="text-center">
                                            <p className="text-white mb-1 font-bold">{managingMatch.team1}</p>
                                            <div className="flex items-center space-x-2">
                                                <button onClick={() => setLiveScore1(Math.max(0, liveScore1 - 1))} className="w-8 h-8 bg-gray-700 rounded text-white">-</button>
                                                <input type="number" value={liveScore1} onChange={e => setLiveScore1(e.target.value)} className="w-16 text-center bg-black border border-gray-600 rounded text-xl text-yellow-400 font-mono" />
                                                <button onClick={() => setLiveScore1(parseInt(liveScore1) + 1)} className="w-8 h-8 bg-green-600 rounded text-white">+</button>
                                            </div>
                                        </div>
                                        <span className="text-2xl font-bold text-gray-500">-</span>
                                        <div className="text-center">
                                            <p className="text-white mb-1 font-bold">{managingMatch.team2}</p>
                                            <div className="flex items-center space-x-2">
                                                <button onClick={() => setLiveScore2(Math.max(0, liveScore2 - 1))} className="w-8 h-8 bg-gray-700 rounded text-white">-</button>
                                                <input type="number" value={liveScore2} onChange={e => setLiveScore2(e.target.value)} className="w-16 text-center bg-black border border-gray-600 rounded text-xl text-yellow-400 font-mono" />
                                                <button onClick={() => setLiveScore2(parseInt(liveScore2) + 1)} className="w-8 h-8 bg-green-600 rounded text-white">+</button>
                                            </div>
                                        </div>
                                    </div>

                                    {/* CONTROLS */}
                                    <div className="mt-8 space-y-4">
                                        <button onClick={saveLiveUpdate} className="w-full py-3 rounded bg-blue-600 hover:bg-blue-500 text-white font-bold shadow-lg">
                                            Salva Aggiornamenti (Senza Finalizzare)
                                        </button>
                                        <button onClick={handleFinalizeMatch} className="w-full py-3 rounded bg-red-600 hover:bg-red-500 text-white font-bold shadow-lg border-2 border-red-400">
                                            CONCLUDI PARTITA E AGGIORNA STATISTICHE
                                        </button>
                                        <p className="text-xs text-gray-400 text-center">Usa "Concludi" solo a fine partita per sommare gol/assist alla classifica generale.</p>
                                    </div>
                                </div>

                                {/* MARCATORI & EVENTI */}
                                <div>
                                    <label className="block text-sm text-gray-400 mb-2">Eventi Partita</label>

                                    {/* SELECTORS UI */}
                                    <PlayerStatSelector team={team1Obj} teamName={managingMatch.team1} onAddEvent={addEvent} />
                                    <PlayerStatSelector team={team2Obj} teamName={managingMatch.team2} onAddEvent={addEvent} />

                                    <div className="mt-4 bg-black/50 p-2 rounded max-h-48 overflow-y-auto">
                                        <h6 className="text-xs font-bold text-gray-500 uppercase mb-2">Log Eventi</h6>
                                        {matchEvents.map((e, idx) => (
                                            <div key={e.id || idx} className="flex justify-between items-center text-sm border-b border-gray-800 py-1">
                                                <span>
                                                    <span className="mr-1">
                                                        {e.type === 'goal' && 'âš½'}
                                                        {e.type === 'assist' && 'ðŸŽ¯'}
                                                        {e.type === 'cleanSheet' && 'ðŸ§¤'}
                                                        {e.type === 'yellow' && 'ðŸŸ¨'}
                                                        {e.type === 'red' && 'ðŸŸ¥'}
                                                    </span>
                                                    {e.minute && <span className="text-yellow-400 font-mono mr-1">[{e.minute}']</span>}
                                                    {e.player} <span className="text-gray-500">({e.team})</span>
                                                </span>
                                                <button onClick={() => removeEvent(e.id)} className="text-red-500 hover:text-white px-2">x</button>
                                            </div>
                                        ))}
                                        {matchEvents.length === 0 && <p className="text-gray-500 italic text-center text-xs">Nessun evento</p>}
                                    </div>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        };


        // LoginPanel (email/password only; no registration UI)
        const LoginPanel = ({ firebaseTools }) => {
            const [email, setEmail] = useState('');
            const [password, setPassword] = useState('');
            const [loading, setLoading] = useState(false);

            const submit = async (e) => {
                e.preventDefault();
                setLoading(true);
                try {
                    await firebaseTools.auth.setPersistence();
                    await firebaseTools.auth.signInWithEmailAndPassword(email, password);
                    // onAuthStateChanged will handle rest
                } catch (err) {
                    console.error('login err', err);
                    showCustomModal('Errore login', err.message || String(err), 'error');
                } finally {
                    setLoading(false);
                }
            };

            return (
                <div className="min-h-screen flex items-center justify-center p-4">
                    <div className="w-full max-w-md bg-gray-900 p-6 rounded-xl shadow-xl border border-gray-700">
                        <h3 className="text-2xl font-bold text-white mb-4">Accesso Pannello Admin</h3>
                        <form onSubmit={submit}>
                            <label className="block text-sm text-gray-300 mb-1">Email</label>
                            <input className={styles.input} type="email" required value={email} onChange={(e) => setEmail(e.target.value)} />
                            <label className="block text-sm text-gray-300 mb-1 mt-3">Password</label>
                            <input className={styles.input} type="password" required value={password} onChange={(e) => setPassword(e.target.value)} />
                            <div className="flex justify-end mt-4">
                                <button disabled={loading} className="bg-indigo-600 text-white px-4 py-2 rounded-lg hover:bg-indigo-500">{loading ? 'Caricamento...' : 'Accedi'}</button>
                            </div>
                        </form>
                        <div className="mt-4 text-sm text-gray-400">
                            <p>Nota: la registrazione Ã¨ disabilitata qui. Crea il tuo account admin nella Firebase Console (Authentication â†’ Users â†’ Add user).</p>
                        </div>
                    </div>
                </div>
            );
        };
        // TeamManager (full)
        const TeamManager = ({ authReady, currentTeams, showMessage, firebaseTools }) => {
            const [teamName, setTeamName] = useState('');
            const [logoUrl, setLogoUrl] = useState(''); // NEW: Logo URL
            const [group, setGroup] = useState('A'); // NEW: Group

            // Players ora Ã¨ array di oggetti: { name, number, age, role }
            const [players, setPlayers] = useState([
                { name: '', number: '', age: '', role: 'Giocatore' },
                { name: '', number: '', age: '', role: 'Giocatore' },
                { name: '', number: '', age: '', role: 'Giocatore' },
                { name: '', number: '', age: '', role: 'Giocatore' },
                { name: '', number: '', age: '', role: 'Giocatore' }
            ]);
            const [editTeam, setEditTeam] = useState(null);
            const [isSaving, setIsSaving] = useState(false);
            const isEditMode = !!editTeam;

            const handlePlayerChange = (index, field, value) => {
                const newPlayers = [...players];
                newPlayers[index] = { ...newPlayers[index], [field]: value };
                setPlayers(newPlayers);
            };

            const addPlayer = () => setPlayers([...players, { name: '', number: '', age: '', role: 'Giocatore' }]);

            const removePlayer = (index) => {
                if (players.length > 5) {
                    setPlayers(players.filter((_, i) => i !== index));
                } else {
                    showMessage('Ogni squadra deve avere almeno 5 giocatori.', 'error', 'team');
                }
            };

            const resetForm = () => {
                setTeamName('');
                setLogoUrl(''); // Reset logo
                setGroup('A'); // Reset group
                setPlayers(Array(5).fill({ name: '', number: '', age: '', role: 'Giocatore' }));
                setEditTeam(null);
            };

            const startEdit = (team) => {
                setTeamName(team.name);
                setLogoUrl(team.logoUrl || ''); // Load logo
                setGroup(team.group || 'A'); // Load group

                // Migrazione dati vecchi (stringhe) -> oggetti
                let initialPlayers = [];
                if (team.players && team.players.length > 0) {
                    initialPlayers = team.players.map(p => {
                        if (typeof p === 'string') return { name: p, number: '', age: '', role: 'Giocatore' };
                        return p;
                    });
                }
                // Ensure at least 5
                if (initialPlayers.length < 5) {
                    initialPlayers = [...initialPlayers, ...Array(5 - initialPlayers.length).fill({ name: '', number: '', age: '', role: 'Giocatore' })];
                }
                setPlayers(initialPlayers);
                setEditTeam(team);
                document.getElementById('team-form-title')?.scrollIntoView({ behavior: 'smooth' });
            };

            const handleSaveTeam = async () => {
                if (!authReady) {
                    showMessage('Autenticazione richiesta', 'Attendi il completamento dell\'accesso o ricarica la pagina.', 'error');
                    return;
                }
                setIsSaving(true);
                const trimmedName = teamName.trim();

                // Validate
                const validPlayers = players.filter(p => p.name.trim() !== '');

                if (!trimmedName || validPlayers.length < 5) {
                    showMessage('Nome squadra e almeno 5 nomi giocatori sono obbligatori.', 'error', 'team');
                    setIsSaving(false);
                    return;
                }

                try {
                    const teamData = {
                        name: trimmedName,
                        logoUrl: logoUrl.trim(), // Save logo
                        group: group, // Save group
                        players: validPlayers.map(p => ({
                            name: p.name.trim(),
                            number: p.number.trim(),
                            age: p.age.trim(),
                            role: p.role.trim() || 'Giocatore'
                        })),
                        lastUpdate: new Date().toISOString()
                    };

                    if (isEditMode) {
                        await firebaseTools.updateTeam(editTeam.id, teamData);
                        showMessage(`Squadra ${trimmedName} aggiornata con successo!`, 'success', 'team');
                    } else {
                        await firebaseTools.addTeam(teamData);
                        showMessage(`Squadra ${trimmedName} aggiunta con successo!`, 'success', 'team');
                    }
                    resetForm();
                } catch (error) {
                    console.error("Errore nel salvataggio della squadra:", error);
                    showMessage("Errore nel salvataggio della squadra: " + (error.message || String(error)), 'error', 'team');
                } finally {
                    setIsSaving(false);
                }
            };

            const handleDeleteTeam = async (teamId, teamName) => {
                if (!authReady) return;
                try {
                    await firebaseTools.deleteTeam(teamId);
                    showMessage(`Squadra ${teamName} eliminata.`, 'success', 'team');
                    await firebaseTools.deleteResultsByTeamName(teamName);
                } catch (error) {
                    console.error("Errore nell'eliminazione della squadra:", error);
                    showMessage("Errore nell'eliminazione della squadra: " + (error.message || String(error)), 'error', 'team');
                }
            };

            const sortedTeams = (currentTeams || []).filter(t => t.name).sort((a, b) => a.name.localeCompare(b.name));

            return (
                <div id="teams" className="admin-section border-l-8 border-yellow-400">
                    <h3 className="text-4xl font-bold text-yellow-400 mb-6">Gestione Squadre</h3>

                    {/* Form */}
                    <div className="mb-8 p-6 bg-gray-900 rounded-lg border border-yellow-500/50">
                        <h4 id="team-form-title" className="text-2xl font-semibold mb-4 text-white">
                            {isEditMode ? `Modifica Squadra: ${teamName}` : 'Aggiungi Nuova Squadra'}
                        </h4>

                        <div className="flex flex-col md:flex-row gap-4 mb-4">
                            <div class="flex-grow">
                                <label className="block text-sm text-gray-400 mb-1">Nome Squadra</label>
                                <input type="text" id="team-name-input" className={styles.input} placeholder="Es: FC Zenith"
                                    value={teamName} onChange={(e) => setTeamName(e.target.value)} disabled={isSaving || !authReady} />
                            </div>
                            <div className="md:w-1/4">
                                <label className="block text-sm text-gray-400 mb-1">Girone</label>
                                <select className={styles.input} value={group} onChange={(e) => setGroup(e.target.value)} disabled={isSaving || !authReady}>
                                    <option value="A">Girone A</option>
                                    <option value="B">Girone B</option>
                                    <option value="C">Girone C</option>
                                    <option value="D">Girone D</option>
                                </select>
                            </div>
                            <div className="md:w-1/3">
                                <label className="block text-sm text-gray-400 mb-1">URL Logo (Opzionale)</label>
                                <input type="text" className={styles.input} placeholder="https://..."
                                    value={logoUrl} onChange={(e) => setLogoUrl(e.target.value)} disabled={isSaving || !authReady} />
                            </div>
                        </div>

                        <div className="space-y-4 mb-4 mt-4">
                            <h5 className="text-lg font-medium text-gray-300">Giocatori (minimo 5)</h5>
                            {players.map((player, index) => (
                                <div key={index} className="flex flex-wrap md:flex-nowrap gap-2 items-end bg-gray-800 p-3 rounded-lg border border-gray-700">
                                    <div className="flex-grow">
                                        <label className="text-xs text-gray-400 block mb-1">Nome</label>
                                        <input type="text" className="w-full bg-gray-700 text-white p-2 rounded focus:ring-1 focus:ring-yellow-500 outline-none"
                                            placeholder="Nome" value={player.name}
                                            onChange={(e) => handlePlayerChange(index, 'name', e.target.value)} disabled={isSaving || !authReady} />
                                    </div>
                                    <div className="w-24">
                                        <label className="text-xs text-gray-400 block mb-1">Numero</label>
                                        <input type="number" className="w-full bg-gray-700 text-white p-2 rounded focus:ring-1 focus:ring-yellow-500 outline-none"
                                            placeholder="#" value={player.number}
                                            onChange={(e) => handlePlayerChange(index, 'number', e.target.value)} disabled={isSaving || !authReady} />
                                    </div>
                                    <div className="w-24">
                                        <label className="text-xs text-gray-400 block mb-1">EtÃ </label>
                                        <input type="number" className="w-full bg-gray-700 text-white p-2 rounded focus:ring-1 focus:ring-yellow-500 outline-none"
                                            placeholder="EtÃ " value={player.age}
                                            onChange={(e) => handlePlayerChange(index, 'age', e.target.value)} disabled={isSaving || !authReady} />
                                    </div>
                                    <div className="w-1/3 min-w-[120px]">
                                        <label className="text-xs text-gray-400 block mb-1">Ruolo</label>
                                        <select className="w-full bg-gray-700 text-white p-2 rounded focus:ring-1 focus:ring-yellow-500 outline-none"
                                            value={player.role} onChange={(e) => handlePlayerChange(index, 'role', e.target.value)} disabled={isSaving || !authReady}>
                                            <option value="Portiere">Portiere</option>
                                            <option value="Difensore">Difensore</option>
                                            <option value="Centrocampista">Centrocampista</option>
                                            <option value="Attaccante">Attaccante</option>
                                            <option value="Jolly">Jolly</option>
                                            <option value="Giocatore">Giocatore</option>
                                        </select>
                                    </div>
                                    <button onClick={() => removePlayer(index)} className="bg-red-900/50 hover:bg-red-900 text-red-200 p-2 rounded transition md:self-end self-center mb-[1px]"
                                        disabled={players.length <= 5 || isSaving || !authReady} title="Rimuovi">
                                        âœ•
                                    </button>
                                </div>
                            ))}
                        </div>

                        <button onClick={addPlayer} className="bg-blue-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-blue-500 transition duration-300 mt-2 disabled:opacity-50" disabled={isSaving || !authReady}>+ Aggiungi Giocatore</button>

                        <div className="flex space-x-4 mt-6">
                            <button onClick={handleSaveTeam} className={`w-full font-bold py-3 rounded-lg shadow-md transition duration-300 disabled:opacity-50 ${isEditMode ? 'bg-orange-600 hover:bg-orange-500' : 'bg-green-600 hover:bg-green-500'}`} disabled={isSaving || !authReady}>
                                {isSaving ? 'Salvataggio...' : (isEditMode ? 'Aggiorna Squadra' : 'Salva Nuova Squadra')}
                            </button>
                            {isEditMode && (
                                <button onClick={resetForm} className="w-full bg-gray-600 text-white font-bold py-3 rounded-lg shadow-md hover:bg-gray-500 transition duration-300 disabled:opacity-50" disabled={isSaving || !authReady}>Annulla Modifica</button>
                            )}
                        </div>
                        {!authReady && <p className="text-red-400 text-sm mt-2">Attendere l'autenticazione per salvare i dati.</p>}
                    </div>

                    {/* Lista */}
                    <h4 className="text-2xl font-semibold mb-4 text-white">Squadre Iscritte ({sortedTeams.length})</h4>
                    <ul className="space-y-3">
                        {sortedTeams.length === 0 ? (
                            <li className="p-3 bg-gray-800 rounded-lg text-gray-400 text-center">Nessuna squadra iscritta.</li>
                        ) : (
                            sortedTeams.map(team => (
                                <li key={team.id} className="p-4 bg-gray-900 rounded-lg flex justify-between items-center border-l-4 border-yellow-400/50">
                                    <div>
                                        <p className="text-xl font-semibold text-white">{team.name}</p>
                                        <p className="text-sm text-gray-400">{(team.players || []).length} Giocatori</p>
                                    </div>
                                    <div className="flex space-x-2">
                                        <button onClick={() => startEdit(team)} className="text-indigo-400 hover:text-indigo-300 p-2 rounded-full hover:bg-gray-800 transition disabled:opacity-50" title="Modifica" disabled={!authReady}>
                                            <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-7-7l4 4m-4-4l-4 4m8-4l-4 4m0 0l-4 4m4-4l-4 4M15 5l2 2m-2-2l-2 2"></path></svg>
                                        </button>
                                        <button onClick={() => showMessage('Elimina squadra', `Sei sicuro di voler eliminare definitivamente la squadra ${team.name}? Verranno eliminati anche tutti i risultati associati.`, 'confirm', () => handleDeleteTeam(team.id, team.name))} className="text-red-400 hover:text-red-300 p-2 rounded-full hover:bg-gray-800 transition disabled:opacity-50" title="Elimina" disabled={!authReady}>
                                            <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                                        </button>
                                    </div>
                                </li>
                            ))
                        )}
                    </ul>
                </div>
            );
        };


        // PollManager
        const PollManager = ({ authReady, showMessage, firebaseTools }) => {
            const [question, setQuestion] = useState('');
            const [options, setOptions] = useState(['', '']); // Dynamic Options
            const [polls, setPolls] = useState([]);
            const [isAdding, setIsAdding] = useState(false);

            useEffect(() => {
                const unsubscribe = firebaseTools.onPollsSnapshot(setPolls);
                return () => unsubscribe();
            }, []);

            const updateOption = (idx, val) => {
                const newOpts = [...options];
                newOpts[idx] = val;
                setOptions(newOpts);
            };

            const addOptionField = () => setOptions([...options, '']);
            const removeOptionField = (idx) => {
                if (options.length <= 2) return;
                setOptions(options.filter((_, i) => i !== idx));
            };

            const handleAddPoll = async () => {
                if (!authReady) return showMessage('Autenticazione richiesta', 'error');
                const validOptions = options.map(o => o.trim()).filter(o => o !== '');

                if (!question.trim() || validOptions.length < 2) return showMessage('Domanda e almeno 2 opzioni valide richieste', 'error');

                setIsAdding(true);
                try {
                    const pollData = {
                        question: question.trim(),
                        options: validOptions,
                        votes: {},
                        isActive: true,
                        timestamp: new Date().getTime()
                    };
                    // Initialize 0 votes for each option to ensure field exists
                    validOptions.forEach(op => pollData.votes[op] = 0);

                    await firebaseTools.addPoll(pollData);
                    showMessage('Sondaggio creato!', 'success');
                    setQuestion('');
                    setOptions(['', '']);
                } catch (e) {
                    showMessage('Errore creazione sondaggio', 'error');
                    console.error(e);
                }
                setIsAdding(false);
            };

            const toggleStatus = async (poll) => {
                try {
                    await firebaseTools.updatePoll(poll.id, { isActive: !poll.isActive });
                    showMessage(`Sondaggio ${!poll.isActive ? 'attivato' : 'chiuso'}`, 'success');
                } catch (e) { showMessage('Errore aggiornamento', 'error'); }
            };

            const handleDelete = async (id) => {
                if (!confirm('Eliminare sondaggio?')) return;
                try { await firebaseTools.deletePoll(id); showMessage('Eliminato', 'success'); }
                catch (e) { showMessage('Errore', 'error'); }
            };

            return (
                <div className="admin-section border-l-8 border-pink-500 mt-10">
                    <h3 className="text-4xl font-bold text-pink-400 mb-6">Gestione Sondaggi</h3>

                    <div className="mb-8 p-6 bg-gray-900 rounded-lg border border-pink-500/50">
                        <h4 className="text-xl font-semibold mb-4 text-white">Nuovo Sondaggio</h4>
                        <div className="space-y-3">
                            <input type="text" value={question} onChange={e => setQuestion(e.target.value)} placeholder="Domanda (es: Chi vince?)" className={styles.input} />

                            <div className="space-y-2">
                                {options.map((opt, idx) => (
                                    <div key={idx} className="flex gap-2">
                                        <input
                                            type="text"
                                            value={opt}
                                            onChange={e => updateOption(idx, e.target.value)}
                                            placeholder={`Opzione ${idx + 1}`}
                                            className={styles.input}
                                        />
                                        {options.length > 2 && (
                                            <button onClick={() => removeOptionField(idx)} className="bg-red-600 hover:bg-red-500 text-white px-3 rounded font-bold">X</button>
                                        )}
                                    </div>
                                ))}
                            </div>

                            <button onClick={addOptionField} className="text-sm text-pink-400 hover:text-white underline">+ Aggiungi Opzione</button>

                            <button onClick={handleAddPoll} disabled={isAdding} className="w-full bg-pink-600 hover:bg-pink-500 text-white font-bold py-3 rounded transition mt-4">
                                {isAdding ? 'Creazione...' : 'Crea Sondaggio'}
                            </button>
                        </div>
                    </div>

                    <div className="space-y-4">
                        {polls.map(poll => (
                            <div key={poll.id} className="bg-gray-800 p-4 rounded flex justify-between items-center">
                                <div>
                                    <p className="text-white font-bold text-lg">{poll.question}</p>
                                    <p className="text-gray-400 text-sm">Status: <span className={poll.isActive ? 'text-green-400' : 'text-red-400'}>{poll.isActive ? 'ATTIVO' : 'CHIUSO'}</span></p>
                                    <p className="text-gray-500 text-xs mt-1">Voti: {Object.entries(poll.votes || {}).map(([k, v]) => `${k}: ${v}`).join(', ')}</p>
                                </div>
                                <div className="flex space-x-2">
                                    <button onClick={() => toggleStatus(poll)} className="bg-blue-600 px-3 py-1 rounded text-white text-sm">{poll.isActive ? 'Chiudi' : 'Apri'}</button>
                                    <button onClick={() => handleDelete(poll.id)} className="bg-red-600 px-3 py-1 rounded text-white text-sm">Elimina</button>
                                </div>
                            </div>
                        ))}
                        {polls.length === 0 && <p className="text-gray-500">Nessun sondaggio.</p>}
                    </div>
                </div>
            );
        };
        // NEWSMANAGER
        const NewsManager = ({ authReady, currentNews, showMessage, firebaseTools }) => {
            const [title, setTitle] = useState('');
            const [content, setContent] = useState('');
            const [imageUrl, setImageUrl] = useState('');
            const [category, setCategory] = useState('Generale');
            const [isAdding, setIsAdding] = useState(false);
            const [editingId, setEditingId] = useState(null); // Track ID for editing

            const handleSaveNews = async () => {
                if (!authReady) { showMessage('Autenticazione richiesta', 'Attendi l\'accesso', 'error'); return; }
                if (!title.trim() || !content.trim()) { showMessage('Titolo e contenuto sono obbligatori.', 'error', 'news'); return; }

                setIsAdding(true);
                try {
                    const newsData = {
                        title: title.trim(),
                        content: content.trim(),
                        image: imageUrl.trim() || null,
                        category: category,
                        // Timestamp: update only if new, or keep original? Usually keep original for news order, or update 'lastUpdated'.
                        // Let's keep original timestamp if editing to preserve order, or update if desired.
                        // For simplicity, let's NOT update timestamp on edit to keep it in same place in list, or maybe add 'updatedAt'.
                        // If it's new, set timestamp.
                    };

                    if (!editingId) {
                        newsData.timestamp = firebaseTools.serverTimestamp();
                        await firebaseTools.addNews(newsData);
                        showMessage(`Notizia "${title}" aggiunta con successo!`, 'success', 'news');
                    } else {
                        newsData.lastUpdate = firebaseTools.serverTimestamp();
                        await firebaseTools.updateNews(editingId, newsData);
                        showMessage(`Notizia "${title}" aggiornata con successo!`, 'success', 'news');
                    }

                    resetForm();
                } catch (error) {
                    console.error("Errore nel salvataggio della notizia:", error);
                    showMessage("Errore: " + (error.message || String(error)), 'error', 'news');
                } finally {
                    setIsAdding(false);
                }
            };

            const startEdit = (news) => {
                setTitle(news.title);
                setContent(news.content);
                setImageUrl(news.image || '');
                setCategory(news.category || 'Generale');
                setEditingId(news.id);
                // Scroll to form
                document.getElementById('news-manager-form')?.scrollIntoView({ behavior: 'smooth' });
            };

            const resetForm = () => {
                setTitle('');
                setContent('');
                setImageUrl('');
                setCategory('Generale');
                setEditingId(null);
            };

            const handleDeleteNews = async (newsId, newsTitle) => {
                if (!authReady) return;
                try {
                    await firebaseTools.deleteNews(newsId);
                    showMessage(`Notizia "${newsTitle}" eliminata.`, 'success', 'news');
                } catch (error) {
                    console.error("Errore nell'eliminazione della notizia:", error);
                    showMessage("Errore nell'eliminazione della notizia: " + (error.message || String(error)), 'error', 'news');
                }
            };

            const sortedNews = (currentNews || []).slice().sort((a, b) => b.timestamp - a.timestamp);

            return (
                <div id="news" className="admin-section border-l-8 border-purple-400 mt-10">
                    <h3 className="text-4xl font-bold text-purple-400 mb-6">Gestione News</h3>

                    {/* Form Aggiungi News */}
                    <div id="news-manager-form" className="p-6 bg-gray-900 rounded-lg border border-purple-500/50 mb-8">
                        <h4 className="text-2xl font-semibold text-white mb-4">{editingId ? 'Modifica Notizia' : 'Aggiungi Nuova Notizia'}</h4>
                        {!authReady && <p className="text-red-400 text-sm mb-4">Attendere l'autenticazione per aggiungere notizie.</p>}

                        <div className="space-y-4">
                            <div>
                                <label htmlFor="news-title" className="block text-sm font-medium text-gray-300">Titolo</label>
                                <input type="text" id="news-title" className={styles.input + ' mt-1 block w-full'} placeholder="Titolo della notizia" value={title} onChange={(e) => setTitle(e.target.value)} disabled={!authReady} />
                            </div>
                            <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label htmlFor="news-category" className="block text-sm font-medium text-gray-300">Categoria</label>
                                    <input type="text" list="category-options" id="news-category" className={styles.input + ' mt-1 block w-full'} value={category} onChange={(e) => setCategory(e.target.value)} disabled={!authReady} placeholder="Seleziona o scrivi..." />
                                    <datalist id="category-options">
                                        <option value="Generale" />
                                        <option value="Partita" />
                                        <option value="Mercato" />
                                        <option value="Intervista" />
                                        <option value="Evento" />
                                        <option value="Comunicato" />
                                    </datalist>
                                </div>
                                <div>
                                    <label htmlFor="news-image" className="block text-sm font-medium text-gray-300">URL Immagine (Opzionale)</label>
                                    <input type="text" id="news-image" className={styles.input + ' mt-1 block w-full'} placeholder="https://..." value={imageUrl} onChange={(e) => setImageUrl(e.target.value)} disabled={!authReady} />
                                </div>
                            </div>
                            <div>
                                <label htmlFor="news-content" className="block text-sm font-medium text-gray-300">Contenuto (Breve)</label>
                                <textarea id="news-content" rows="4" className={styles.input + ' mt-1 block w-full'} placeholder="Inserisci il contenuto o il riassunto della notizia..." value={content} onChange={(e) => setContent(e.target.value)} disabled={!authReady}></textarea>
                            </div>
                            <div className="flex space-x-4">
                                <button onClick={handleSaveNews} className={`w-full font-bold py-3 px-6 rounded-lg shadow-lg transition duration-300 disabled:opacity-50 ${editingId ? 'bg-orange-600 hover:bg-orange-500' : 'bg-purple-600 hover:bg-purple-500'} text-white`} disabled={isAdding || !authReady || !title.trim() || !content.trim()}>
                                    {isAdding ? 'Salvataggio...' : (editingId ? 'Aggiorna Notizia' : 'Pubblica Notizia')}
                                </button>
                                {editingId && (
                                    <button onClick={resetForm} className="bg-gray-600 text-white font-bold py-3 px-6 rounded-lg hover:bg-gray-500 transition duration-300">Annulla</button>
                                )}
                            </div>
                        </div>
                    </div>

                    {/* Storico News */}
                    <h4 className="text-2xl font-semibold mb-4 text-white">Notizie Pubblicate ({sortedNews.length})</h4>
                    <div className="space-y-3">
                        {sortedNews.length === 0 ? (
                            <p className="text-gray-500 p-4 bg-gray-800 rounded-lg">Nessuna notizia pubblicata.</p>
                        ) : (
                            sortedNews.map(news => (
                                <div key={news.id} className="p-4 bg-gray-800 rounded-lg flex justify-between items-center hover:bg-gray-700 transition">
                                    <div>
                                        <p className="text-lg font-semibold text-purple-300">{news.title}</p>
                                        <p className="text-sm text-gray-400 truncate max-w-lg">{news.content}</p>
                                    </div>
                                    <div className="flex space-x-2">
                                        <button onClick={() => startEdit(news)} className="text-indigo-400 hover:text-indigo-300 p-2 rounded-full hover:bg-gray-700 transition" title="Modifica">
                                            <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-7-7l4 4m-4-4l-4 4m8-4l-4 4m0 0l-4 4m4-4l-4 4M15 5l2 2m-2-2l-2 2"></path></svg>
                                        </button>
                                        <button
                                            onClick={() => showMessage('Elimina Notizia', `Sei sicuro di voler eliminare la notizia: "${news.title}"?`, 'confirm', () => handleDeleteNews(news.id, news.title))}
                                            className="text-red-400 hover:text-red-300 p-2 rounded-full hover:bg-gray-700 transition disabled:opacity-50"
                                            title="Elimina Notizia"
                                            disabled={!authReady}
                                        >
                                            <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                                        </button>
                                    </div>
                                </div>
                            ))
                        )}
                    </div>
                </div>
            );
        };

        // MAIN APP
        const App = () => {
            const [isFirebaseInitialized, setIsFirebaseInitialized] = useState(false);
            const [authReady, setAuthReady] = useState(false);
            const [user, setUser] = useState(null);
            const [loadingData, setLoadingData] = useState(true);
            const [currentTeams, setCurrentTeams] = useState([]);
            const [currentResults, setCurrentResults] = useState([]);
            const [currentNews, setCurrentNews] = useState([]);

            const [systemMessage, setSystemMessage] = useState({ isVisible: false, title: '', message: '', type: 'info' });
            const [modal, setModal] = useState({ isVisible: false, title: '', message: '', onConfirm: () => { } });

            const showMessage = useCallback((title, message, type = 'info', onConfirm = null) => {
                if (type === 'confirm' && onConfirm) {
                    setModal({ isVisible: true, title, message, onConfirm: () => { onConfirm(); setModal({ isVisible: false, title: '', message: '', onConfirm: () => { } }); } });
                } else {
                    setSystemMessage({ isVisible: true, title, message, type });
                    setTimeout(() => setSystemMessage(prev => ({ ...prev, isVisible: false })), 5000);
                }
            }, []);

            const [firebaseTools, setFirebaseTools] = useState(null);

            useEffect(() => {
                if (window.firebaseTools) {
                    setFirebaseTools(window.firebaseTools);
                    setIsFirebaseInitialized(true);
                    const { auth } = window.firebaseTools;
                    const unsubscribe = auth.onAuthStateChanged((u) => {
                        setUser(u || null);
                        setAuthReady(true);
                        console.log(u ? `Utente autenticato. UID: ${u.uid}` : 'Nessun utente autenticato.');
                    });
                    return () => { if (typeof unsubscribe === 'function') unsubscribe(); };
                }
            }, []);

            useEffect(() => {
                if (!authReady || !firebaseTools) return;
                if (!user) { setCurrentTeams([]); setCurrentResults([]); setCurrentNews([]); setLoadingData(false); return; }

                setLoadingData(true);
                const teamsRef = firebaseTools.getTeamsCollectionRef();
                const resultsRef = firebaseTools.getResultsCollectionRef();
                const newsRef = firebaseTools.getNewsCollectionRef();

                const unsubscribeTeams = firebaseTools.onSnapshot(teamsRef, (snapshot) => {
                    const teamsData = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    setCurrentTeams(teamsData);
                    setLoadingData(false);
                }, (error) => {
                    console.error("Errore onSnapshot Squadre:", error);
                    showMessage("Errore nel caricamento delle squadre.", 'error');
                    setLoadingData(false);
                });

                const unsubscribeResults = firebaseTools.onSnapshot(resultsRef, (snapshot) => {
                    const resultsData = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    setCurrentResults(resultsData);
                    setLoadingData(false);
                }, (error) => {
                    console.error("Errore onSnapshot Risultati:", error);
                    showMessage("Errore nel caricamento dei risultati.", 'error');
                    setLoadingData(false);
                });

                const unsubscribeNews = firebaseTools.onSnapshot(newsRef, (snapshot) => {
                    const newsData = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    setCurrentNews(newsData.map(n => ({ ...n, timestamp: n.timestamp?.toDate ? n.timestamp.toDate().getTime() : new Date(n.timestamp).getTime() }))); // Conversione del timestamp per l'ordinamento
                    setLoadingData(false);
                }, (error) => {
                    console.error("Errore onSnapshot Notizie:", error);
                    showMessage("Errore nel caricamento delle notizie.", 'error');
                    setLoadingData(false);
                });
                return () => {
                    try { unsubscribeTeams && unsubscribeTeams(); } catch (e) { }
                    try { unsubscribeResults && unsubscribeResults(); } catch (e) { }
                    try { unsubscribeNews && unsubscribeNews(); } catch (e) { }
                };
            }, [authReady, firebaseTools, user, showMessage]);

            const isLoading = !isFirebaseInitialized || !authReady || loadingData;

            // Authorization check against allowed emails
            const isUserAuthorized = useMemo(() => {
                const allowed = window.__admin_allowed_emails || [];
                if (!user) return false;
                if (!allowed || allowed.length === 0) return true;
                return !!user.email && allowed.includes(user.email);
            }, [user]);

            const handleLogout = async () => {
                try {
                    await firebaseTools.auth.signOut();
                    setUser(null);
                    showMessage('Logout eseguito', 'Sei stato disconnesso.', 'success');
                } catch (err) {
                    console.error('Errore logout', err);
                    showMessage('Errore logout: ' + (err.message || String(err)), 'error');
                }
            };

            if (isLoading) {
                return (
                    <div className="flex flex-col justify-center items-center min-h-screen">
                        <div className="flex space-x-2"><div className="loading-dot"></div><div className="loading-dot"></div><div className="loading-dot"></div></div>
                        <p className="mt-6 text-gray-400 text-xl font-semibold">{(!isFirebaseInitialized || !authReady) ? "Connessione al Database e Autenticazione..." : "Caricamento Dati in Tempo Reale..."}</p>
                    </div>
                );
            }

            if (!user) {
                return (
                    <div>
                        <SystemAlert isVisible={systemMessage.isVisible} title={systemMessage.title} message={systemMessage.message} type={systemMessage.type} onClose={() => setSystemMessage(prev => ({ ...prev, isVisible: false }))} />
                        <LoginPanel firebaseTools={firebaseTools} />
                    </div>
                );
            }

            if (!isUserAuthorized) {
                return (
                    <div className="min-h-screen flex items-center justify-center">
                        <div className="bg-gray-900 p-8 rounded-xl shadow-xl text-center max-w-lg">
                            <h3 className="text-2xl font-bold text-red-400 mb-4">Accesso non autorizzato</h3>
                            <p className="text-gray-300 mb-4">L'account con cui hai effettuato l'accesso non Ã¨ nella lista degli amministratori.</p>
                            <p className="text-sm text-gray-400 mb-6">Controlla l'email o contatta l'amministratore.</p>
                            <button onClick={handleLogout} className="bg-indigo-600 text-white px-4 py-2 rounded-lg">Esci</button>
                        </div>
                    </div>
                );
            }

            return (
                <div className="w-full">
                    <SystemAlert isVisible={systemMessage.isVisible} title={systemMessage.title} message={systemMessage.message} type={systemMessage.type} onClose={() => setSystemMessage(prev => ({ ...prev, isVisible: false }))} />
                    <ConfirmationModal isVisible={modal.isVisible} title={modal.title} message={modal.message} onConfirm={modal.onConfirm} onCancel={() => setModal(prev => ({ ...prev, isVisible: false }))} />

                    <h2 className="text-6xl font-extrabold text-center mb-6 nx-text-gradient pt-16">PANNELLO DI AMMINISTRAZIONE</h2>
                    <p className="text-center text-xl text-green-400 mb-8 font-semibold">Accesso Real-Time con Firebase</p>

                    <div className="admin-section border-t-4 border-yellow-500 max-w-xl mx-auto mb-10 text-center">
                        <h2 className="text-xl font-semibold text-gray-300 mb-4">Stato Connessione Database</h2>
                        <p className="text-sm text-gray-400"><strong>Utente:</strong> <span className="font-mono bg-gray-700 p-1 rounded text-xs text-yellow-300 break-all">{user.email || user.uid}</span></p>
                        <p className="text-xs text-gray-500 mt-2">I dati (squadre/risultati) sono salvati in tempo reale sul tuo progetto Firebase.</p>
                        <div className="mt-3"><button onClick={handleLogout} className="bg-red-600 text-white px-3 py-1 rounded">Logout</button></div>

                        <div className="mt-4 border-t border-gray-600 pt-4">
                            <h5 className="text-red-500 font-bold mb-2 text-sm uppercase">Zona Pericolo</h5>
                            <button onClick={() => firebaseTools.resetAllResults()} className="bg-red-900/50 hover:bg-red-800 text-red-200 border border-red-700 px-4 py-2 rounded-lg text-sm font-bold w-full transition">
                                âš ï¸ RESET TOTALE TORNEO
                            </button>
                            <p className="text-[10px] text-gray-500 mt-1">Elimina risultati, calendario e statistiche.</p>
                        </div>
                    </div>

                    <TeamManager authReady={true} currentTeams={currentTeams} showMessage={showMessage} firebaseTools={firebaseTools} />
                    <MatchScheduler authReady={true} teams={currentTeams} currentResults={currentResults} showMessage={showMessage} firebaseTools={firebaseTools} />
                    {/* ResultsManager has been unified into MatchScheduler */}
                    <PollManager authReady={true} showMessage={showMessage} firebaseTools={firebaseTools} />
                    <NewsManager authReady={true} currentNews={currentNews} showMessage={showMessage} firebaseTools={firebaseTools} />
                </div>
            );
        };

        ReactDOM.createRoot(document.getElementById('root')).render(<App />); 
    </script>

    <!-- COOKIE CONSENT BANNER -->
    <div id="cookie-banner"
        class="fixed bottom-0 left-0 right-0 bg-gray-900/95 backdrop-blur border-t border-gray-700 p-6 z-[200] transform transition-transform duration-500 translate-y-full"
        style="display: none;">
        <div class="max-w-7xl mx-auto flex flex-col md:flex-row items-center justify-between gap-4">
            <div class="text-gray-300 text-sm">
                <p class="font-bold text-white mb-1">ðŸª Informativa Privacy</p>
                Questo sito utilizza cookie tecnici essenziali e strumenti di terze parti (Firebase) per il
                funzionamento.
                Continuando a navigare, accetti l'utilizzo dei cookie.
            </div>
            <div class="flex space-x-4">
                <button onclick="acceptCookies()"
                    class="bg-yellow-500 hover:bg-yellow-400 text-black font-bold py-2 px-6 rounded-lg transition">Accetta</button>
            </div>
        </div>
    </div>
    <script>
        function checkCookies() {
            if (!localStorage.getItem('cookieConsent')) {
                const banner = document.getElementById('cookie-banner');
                if (banner) {
                    banner.style.display = 'block';
                    setTimeout(() => banner.classList.remove('translate-y-full'), 100);
                }
            }
        }
        function acceptCookies() {
            localStorage.setItem('cookieConsent', 'true');
            const banner = document.getElementById('cookie-banner');
            if (banner) {
                banner.classList.add('translate-y-full');
                setTimeout(() => banner.style.display = 'none', 500);
            }
        }
        window.addEventListener('load', checkCookies);
    </script>

</body>

</html>
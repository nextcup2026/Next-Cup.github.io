<!DOCTYPE html>
<html lang="it">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NEXT CUP - Accesso</title>
    <link rel="icon" type="image/png" href="favicon.png">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;900&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #020617;
            color: #fff;
        }

        .nx-gradient {
            background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%);
        }

        .input-dark {
            background: #1e293b;
            border: 1px solid #334155;
            color: white;
        }

        .input-dark:focus {
            border-color: #fbbf24;
            outline: none;
            ring: 2px solid #fbbf24;
        }
    </style>
</head>

<body class="min-h-screen flex flex-col">

    <!-- Navbar -->
    <header class="sticky top-0 z-50 bg-gray-950/80 backdrop-blur border-b border-white/10">
        <nav class="max-w-7xl mx-auto px-6 py-4 flex justify-between items-center">
            <div class="flex items-center space-x-3">
                <img src="logo.png" alt="Logo" class="w-12 h-12 rounded-full border border-gray-600">
                <a href="index.html" class="text-2xl font-black text-white">NEXT CUP</a>
            </div>
            <a href="index.html" class="text-gray-400 hover:text-white transition">← Torna alla Home</a>
        </nav>
    </header>

    <main class="flex-grow flex items-center justify-center p-6">
        <div class="w-full max-w-md bg-gray-900 border border-gray-800 rounded-2xl p-8 shadow-2xl">
            <h1 class="text-3xl font-bold text-center mb-2">Benvenuto</h1>
            <p class="text-center text-gray-400 mb-8">Accedi per gestire la tua squadra o il tuo profilo</p>

            <!-- Error Box -->
            <div id="error-box"
                class="hidden bg-red-900/50 border border-red-500/50 p-4 rounded-lg mb-6 text-red-200 text-sm"></div>

            <!-- Google Login -->
            <button id="btn-google"
                class="w-full bg-white text-gray-900 font-bold py-3 px-4 rounded-xl flex items-center justify-center gap-3 hover:bg-gray-100 transition mb-6">
                <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" class="w-5 h-5">
                Accedi con Google
            </button>

            <div class="relative mb-6">
                <div class="absolute inset-0 flex items-center">
                    <div class="w-full border-t border-gray-700"></div>
                </div>
                <div class="relative flex justify-center text-sm"><span class="px-2 bg-gray-900 text-gray-500">oppure
                        email</span></div>
            </div>

            <!-- Email Form -->
            <form id="login-form" class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-400 mb-1">Email</label>
                    <input type="email" id="email" required class="w-full px-4 py-3 rounded-xl input-dark"
                        placeholder="tu@esempio.com">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-400 mb-1">Password</label>
                    <input type="password" id="password" required class="w-full px-4 py-3 rounded-xl input-dark"
                        placeholder="••••••••">
                </div>

                <button type="submit"
                    class="w-full bg-yellow-400 hover:bg-yellow-300 text-gray-900 font-bold py-3 rounded-xl transition shadow-lg">
                    Accedi / Registrati
                </button>
            </form>

            <p class="text-xs text-center text-gray-500 mt-6">
                Creando un account accetti i Termini di Servizio e la Privacy Policy.
            </p>
        </div>
    </main>

    <!-- FIREBASE -->
    <script>
        window.__firebase_config = JSON.stringify({
            apiKey: "AIzaSyDKkaydSHxKT20XzWKfS16H1d6TMNq4p5Q",
            authDomain: "torneo-585ac.firebaseapp.com",
            projectId: "torneo-585ac",
            storageBucket: "torneo-585ac.firebasestorage.app",
            messagingSenderId: "79275251686",
            appId: "1:79275251686:web:15ca08ce46b6ce5e4fa827",
            measurementId: "G-S2NZJJXKWW"
        });
    </script>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithPopup, GoogleAuthProvider, signInWithEmailAndPassword, createUserWithEmailAndPassword, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const app = initializeApp(JSON.parse(window.__firebase_config));
        const auth = getAuth(app);
        const db = getFirestore(app);
        const googleProvider = new GoogleAuthProvider();

        const errorBox = document.getElementById('error-box');

        function showError(msg) {
            errorBox.textContent = msg;
            errorBox.classList.remove('hidden');
        }

        async function postLogin(user) {
            // Create user doc if not exists
            const userRef = doc(db, `artifacts/${JSON.parse(window.__firebase_config).projectId}/users`, user.uid); // NOTE: Check path
            // Actually, we use artifacts path convention: artifacts/{appId}/users
            const appId = "nextcup-app"; // Hardcoded matching other files
            const correctRef = doc(db, `artifacts/${appId}/users`, user.uid);

            try {
                const snap = await getDoc(correctRef);
                if (!snap.exists()) {
                    await setDoc(correctRef, {
                        email: user.email,
                        displayName: user.displayName || user.email.split('@')[0],
                        role: 'user', // default role
                        createdAt: new Date().toISOString()
                    });
                }
                window.location.href = "dashboard.html";
            } catch (e) {
                console.error("User init error", e);
                // Redirect anyway
                window.location.href = "dashboard.html";
            }
        }

        // Google
        document.getElementById('btn-google').addEventListener('click', async () => {
            try {
                const result = await signInWithPopup(auth, googleProvider);
                postLogin(result.user);
            } catch (error) {
                showError("Errore Google: " + error.message);
            }
        });

        // Email
        document.getElementById('login-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('email').value;
            const pass = document.getElementById('password').value;

            try {
                // Try login
                const cred = await signInWithEmailAndPassword(auth, email, pass);
                postLogin(cred.user);
            } catch (error) {
                if (error.code === 'auth/invalid-credential' || error.code === 'auth/user-not-found') {
                    // Try register? Or just tell user.
                    // Let's simplified: Try register if login fails?
                    // Better: explicit register. But for this MVP let's catch 'user-not-found' and create.
                    // Actually auth/invalid-credential is generic now.
                    // Let's just try Create first? No, login first.

                    try {
                        const newCred = await createUserWithEmailAndPassword(auth, email, pass);
                        postLogin(newCred.user);
                    } catch (createErr) {
                        showError("Errore Login/Registrazione: " + error.message);
                    }
                } else {
                    showError(error.message);
                }
            }
        });

        // Auto redirect if already logged in
        onAuthStateChanged(auth, (user) => {
            if (user && !user.isAnonymous) {
                // window.location.href = "dashboard.html"; 
                // Don't auto redirect here because they might want to switch accounts or just landed here.
                // Actually for UX, if they go to login.html and are logged in, redirecting to dashboard is standard.
                setTimeout(() => {
                    window.location.href = "dashboard.html";
                }, 1000);
            }
        });

    </script>
</body>

</html>
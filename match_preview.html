<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NEXT CUP - Anteprima Match AI</title>

    <!-- Favicon -->
    <link rel="icon" type="image/png" href="favicon.png">
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font Inter for modern look -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;900&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #0d1a2f; 
            color: #ffffff;
        }
        .nx-text-gradient {
            background: -webkit-linear-gradient(45deg, #FFD700, #FBBF24, #3b82f6);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        .nx-button-hover {
            transition: all 0.3s ease;
        }
        .nx-button-hover:hover {
            background: linear-gradient(90deg, #facc15, #f59e0b);
            box-shadow: 0 4px 15px rgba(255, 215, 0, 0.4);
            transform: translateY(-2px);
        }
        .nx-analysis-box {
            min-height: 250px;
        }

        .hidden a {
            font-size: 18px;
        }
    </style>
</head>
<body class="antialiased">

    <!-- Navbar (Consistent) -->
    <header class="sticky top-0 z-50 bg-gray-900 bg-opacity-90 backdrop-blur-sm shadow-xl">
        <nav class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4 flex justify-between items-center">
            <div class="flex items-center space-x-2">
                <img class="w-24 h-24 rounded-full border-4 border-gray-600 mb-3" src="logo.png" alt="Logo torneo">
                <a href="index.html" class="text-3xl font-black nx-text-gradient" style="padding-left: 15px">NEXT CUP</a>
            </div>

            <div class="hidden md:flex space-x-8 font-semibold">
                <a href="index.html" class="text-gray-300 hover:text-yellow-400 transition duration-300">Home</a>
                <a href="teams.html" class="text-gray-300 hover:text-yellow-400 transition duration-300">Squadre</a>
                <a href="news.html" class="text-gray-300 hover:text-yellow-400 transition duration-300">Notizie</a>
                <a href="match_preview.html" class="text-yellow-400 transition duration-300">Anteprima Match AI</a>
                <a href="results.html" class="text-gray-300 hover:text-yellow-400 transition duration-300">Risultati & Classifica</a>
                <a href="contact.html" class="text-gray-300 hover:text-yellow-400 transition duration-300">Contatti & Iscrizione</a>
            </div>

            <button class="md:hidden text-gray-300 hover:text-yellow-400 focus:outline-none">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16m-7 6h7"></path></svg>
            </button>
        </nav>
    </header>

    <!-- Main Content: AI Match Preview -->
    <section class="py-16 px-4 sm:px-6 lg:px-8 bg-gray-800 min-h-screen">
        <div class="max-w-4xl mx-auto">
            <h2 class="text-6xl font-extrabold text-center mb-6 nx-text-gradient">ANALISI MATCH AI</h2>
            <p class="text-center text-xl text-gray-300 mb-12">Ottieni l'analisi predittiva e i fattori chiave del prossimo quarto di finale grazie al nostro algoritmo di Intelligenza Artificiale.</p>

            <!-- Match Setup -->
            <div class="bg-gray-900 p-8 rounded-xl shadow-2xl border border-yellow-400/50 mb-10">
                <h3 class="text-3xl font-bold text-white mb-6 text-center">QUARTO DI FINALE: LA SFIDA</h3>
                
                <div class="flex flex-col sm:flex-row justify-around items-center space-y-6 sm:space-y-0 text-center">
                    
                    <!-- Team 1 Selector -->
                    <div class="flex flex-col items-center w-full sm:w-1/3">
                        <!-- Default Logo for Team Alpha Elite -->
                        <img src="https://placehold.co/120x120/1e3a8a/FFD700?text=A" id="team1-logo" alt="Logo Team 1" class="w-24 h-24 rounded-full border-4 border-yellow-400 mb-3">
                        <select id="team1" class="bg-gray-700 text-white p-2 rounded-lg text-lg font-semibold w-full max-w-[200px]">
                            <option value="Team Alpha Elite (Campioni in carica, forte attacco)" data-logo="https://placehold.co/120x120/1e3a8a/FFD700?text=A">Team Alpha Elite</option>
                            <option value="FC Zenith (Finalista 2024, centrocampo di qualità)" data-logo="https://placehold.co/120x120/374151/FFFFFF?text=Z">FC Zenith</option>
                            <option value="Red Devils J. (Giovani talenti, difesa solida)" data-logo="https://placehold.co/120x120/dc2626/FFFFFF?text=R">Red Devils J.</option>
                            <option value="Accademy X (Sotto osservazione, incognita tattica)" data-logo="https://placehold.co/120x120/4c4c4c/FFD700?text=X">Accademy X</option>
                            <option value="Green Lions (Velocità e contropiede)" data-logo="https://placehold.co/120x120/059669/FFFFFF?text=G">Green Lions</option>
                            <option value="Blue Wave (Esperienza, gioco posizionale)" data-logo="https://placehold.co/120x120/1e40af/FFFFFF?text=B">Blue Wave</option>
                            <option value="Virtus Calcio (Miglior difesa del torneo)" data-logo="https://placehold.co/120x120/4f46e5/FFD700?text=V">Virtus Calcio</option>
                            <option value="Latina Power (Outsider, imprevedibile)" data-logo="https://placehold.co/120x120/ef4444/FFFFFF?text=L">Latina Power</option>
                        </select>
                    </div>

                    <div class="text-5xl font-extrabold text-red-500">VS</div>

                    <!-- Team 2 Selector -->
                    <div class="flex flex-col items-center w-full sm:w-1/3">
                        <!-- Default Logo for Red Devils J. -->
                        <img src="https://placehold.co/120x120/dc2626/FFFFFF?text=R" id="team2-logo" alt="Logo Team 2" class="w-24 h-24 rounded-full border-4 border-gray-600 mb-3">
                        <select id="team2" class="bg-gray-700 text-white p-2 rounded-lg text-lg font-semibold w-full max-w-[200px]">
                            <option value="Red Devils J. (Giovani talenti, difesa solida)" data-logo="https://placehold.co/120x120/dc2626/FFFFFF?text=R">Red Devils J.</option>
                            <option value="Team Alpha Elite (Campioni in carica, forte attacco)" data-logo="https://placehold.co/120x120/1e3a8a/FFD700?text=A">Team Alpha Elite</option>
                            <option value="FC Zenith (Finalista 2024, centrocampo di qualità)" data-logo="https://placehold.co/120x120/374151/FFFFFF?text=Z">FC Zenith</option>
                            <option value="Accademy X (Sotto osservazione, incognita tattica)" data-logo="https://placehold.co/120x120/4c4c4c/FFD700?text=X">Accademy X</option>
                            <option value="Green Lions (Velocità e contropiede)" data-logo="https://placehold.co/120x120/059669/FFFFFF?text=G">Green Lions</option>
                            <option value="Blue Wave (Esperienza, gioco posizionale)" data-logo="https://placehold.co/120x120/1e40af/FFFFFF?text=B">Blue Wave</option>
                            <option value="Virtus Calcio (Miglior difesa del torneo)" data-logo="https://placehold.co/120x120/4f46e5/FFD700?text=V">Virtus Calcio</option>
                            <option value="Latina Power (Outsider, imprevedibile)" data-logo="https://placehold.co/120x120/ef4444/FFFFFF?text=L">Latina Power</option>
                        </select>
                    </div>
                </div>

                <div class="text-center mt-8">
                    <button id="analyze-button" onclick="handleAnalysisClick()" class="nx-button-hover bg-blue-600 text-white font-bold py-3 px-10 rounded-lg text-xl shadow-lg flex items-center justify-center mx-auto">
                        <span id="button-text">GENERA ANALISI AI</span>
                    </button>
                </div>
            </div>

            <!-- AI Analysis Output -->
            <div class="bg-gray-900 p-8 rounded-xl shadow-2xl border border-blue-700/50">
                <h3 class="text-3xl font-bold text-yellow-400 mb-6 border-b border-gray-700 pb-3">RISULTATO DELL'ANALISI PREDITTIVA</h3>
                <div id="analysis-output" class="text-gray-300 nx-analysis-box leading-relaxed">
                    Seleziona le due squadre e clicca su "GENERA ANALISI AI" per ricevere la previsione del match in tempo reale.
                </div>
                <!-- Div for sources is included but remains hidden as Grounding is not used for this creative task -->
                <div id="sources-output" class="text-sm text-gray-500 mt-4 pt-4 border-t border-gray-800 hidden"></div>
            </div>

            <!-- Error Modal (Custom implementation instead of alert()) -->
            <div id="error-modal" class="fixed inset-0 bg-black bg-opacity-75 hidden items-center justify-center z-50" onclick="document.getElementById('error-modal').classList.add('hidden')">
                <div class="bg-gray-900 p-6 rounded-xl shadow-2xl max-w-sm mx-auto border border-red-500" onclick="event.stopPropagation()">
                    <h4 class="text-2xl font-bold text-red-500 mb-4">ERRORE</h4>
                    <p id="error-message" class="text-gray-300">Si è verificato un errore durante la generazione dell'analisi. Riprova più tardi.</p>
                    <button class="mt-4 bg-red-600 text-white px-4 py-2 rounded-lg hover:bg-red-500" onclick="document.getElementById('error-modal').classList.add('hidden')">Chiudi</button>
                </div>
            </div>

        </div>
    </section>

    <!-- Footer / Contatti (Consistent) -->
    <footer class="bg-gray-950 py-10 px-4 sm:px-6 lg:px-8">
        <div class="max-w-7xl mx-auto flex flex-col md:flex-row justify-between items-center text-center md:text-left space-y-6 md:space-y-0">
            <div class="text-gray-400">
                <p class="text-xl font-bold nx-text-gradient mb-2">NEXT CUP</p>
                <p>&copy; 2026. Tutti i diritti riservati. Organizzato da Next Cup</p>
            </div>
            <div class="space-y-2">
                <p class="text-white font-semibold">Contattaci</p>
                <p class="text-sm text-gray-400">Email: <a href="mailto:nextcup2026@gmail.com" class="hover:text-yellow-400">nextcup2026@gmail.com</a></p>
                <p class="text-sm text-gray-400">Luca: +39 351 508 6288</p>
                <p class="text-sm text-gray-400">Paolo: +39 320 216 5611</p>
            </div>
            <div class="flex space-x-4 text-gray-400"> 
                <a href="#" class="hover:text-yellow-400 transition duration-300">[Image of Logo di Instagram]</a>
                <a href="#" class="hover:text-yellow-400 transition duration-300"></a>
                <a href="#" class="hover:text-yellow-400 transition duration-300"></a>
            </div>
        </div>
    </footer>

    <script>
        // Variabili Globali e API Setup
        // ***************************************************************
        // IMPORTANTE: Se stai eseguendo in locale (http://localhost:XXXX), INSERISCI LA TUA CHIAVE API qui sotto.
        // Se stai usando l'Anteprima Canvas, lascia pure le virgolette vuote: const apiKey = "";
        const apiKey = "AIzaSyBODHbA0Ef2oAQt4OxADNH5IXSGsQ25ZyQ"; // <--- INSERISCI QUI LA TUA CHIAVE API se sei in locale.
        // ***************************************************************
        const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;
        
        const outputElement = document.getElementById('analysis-output');
        const buttonTextElement = document.getElementById('button-text');
        const analyzeButton = document.getElementById('analyze-button');
        const team1Select = document.getElementById('team1');
        const team2Select = document.getElementById('team2');
        const team1Logo = document.getElementById('team1-logo');
        const team2Logo = document.getElementById('team2-logo');

        // Funzione per mostrare il modal di errore
        function showError(message) {
            document.getElementById('error-message').innerText = message;
            document.getElementById('error-modal').classList.remove('hidden');
            document.getElementById('error-modal').classList.add('flex');
        }

        // Funzione per ritardare l'esecuzione (usata per l'exponential backoff)
        const delay = (ms) => new Promise(resolve => setTimeout(resolve, ms));

        // Aggiorna i loghi in base alla selezione
        function updateLogos() {
            team1Logo.src = team1Select.options[team1Select.selectedIndex].getAttribute('data-logo');
            team2Logo.src = team2Select.options[team2Select.selectedIndex].getAttribute('data-logo');
        }

        team1Select.addEventListener('change', updateLogos);
        team2Select.addEventListener('change', updateLogos);

        window.onload = updateLogos; // Aggiorna i loghi all'avvio

        /**
         * Genera l'analisi del match tramite l'API di Gemini.
         * Implementa l'exponential backoff in caso di fallimento della chiamata.
         */
        async function generateAnalysis(team1Name, team2Name) {
            
            // Verifica semplice della chiave API per l'esecuzione in locale (solo per debug)
            if (apiKey === "" && window.location.protocol.startsWith("http")) {
                 console.warn("ATTENZIONE: Chiave API vuota. Se la chiamata fallisce per errore 400/403, inserisci la tua chiave nella riga 177.");
            }
            
            // Setup UI per il caricamento
            analyzeButton.disabled = true;
            buttonTextElement.innerHTML = '<svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>ANALISI IN CORSO...';
            outputElement.innerHTML = '<p class="text-center text-gray-500">L\'IA sta analizzando i dati... attendi qualche istante.</p>';

            const maxRetries = 3;
            let resultText = "Impossibile ottenere l'analisi. Controlla la console per i dettagli (potrebbe mancare la chiave API, esserci un problema CORS o la chiave non è autorizzata).";

            const systemPrompt = `Sei un esperto analista di calcio giovanile e usi un tono tecnico ma coinvolgente. Il tuo compito è fornire un'analisi predittiva completa, inclusa una previsione del risultato e dei fattori chiave. La risposta DEVE essere in italiano e formattata con Markdown.`;
            
            const userQuery = `Analizza la partita di calcio giovanile Next Cup tra: ${team1Name} vs ${team2Name}. Fornisci: 1. Punti di Forza e Debolezza per ogni squadra (2 punti per parte). 2. Fattore Chiave del Match (un solo punto decisivo). 3. Previsione del Risultato (es: 2-1). Usa titoli in grassetto e liste puntate.`;

            const payload = {
                contents: [{ parts: [{ text: userQuery }] }],
                systemInstruction: { parts: [{ text: systemPrompt }] },
            };

            for (let i = 0; i < maxRetries; i++) {
                try {
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (response.ok) {
                        const result = await response.json();
                        const candidate = result.candidates?.[0];

                        if (candidate && candidate.content?.parts?.[0]?.text) {
                            resultText = candidate.content.parts[0].text;
                            break; // Successo, esci dal loop di retry
                        } else {
                            throw new Error("Risposta API non valida o vuota.");
                        }
                    } else if (response.status === 429 && i < maxRetries - 1) {
                        // Implementazione Exponential Backoff
                        const delayTime = Math.pow(2, i) * 1000;
                        await delay(delayTime);
                        // Continua al prossimo ciclo del for
                    } else {
                        // Cattura errori come 400 (bad request), 401 (Unauthorized - chiave API mancante)
                        const errorBody = await response.text();
                        throw new Error(`Errore HTTP ${response.status}: ${errorBody.substring(0, 100)}...`);
                    }
                } catch (error) {
                    console.error("Tentativo di API fallito:", error);
                    if (i === maxRetries - 1) {
                        showError(`Impossibile connettersi all'AI dopo ${maxRetries} tentativi. Dettagli: ${error.message}`);
                    }
                }
            }
            
            // Re-abilitazione UI
            analyzeButton.disabled = false;
            buttonTextElement.innerText = 'GENERA ANALISI AI';
            
            // Visualizza il risultato finale
            // Sostituisco i ritorni a capo con <br> per la formattazione di base in HTML,
            // e uso espressioni regolari per formattare gli elementi Markdown chiave in HTML.
            let formattedText = resultText;
            formattedText = formattedText.replace(/### (.*)/g, '<h4 class="text-xl font-semibold text-white mt-4">$1</h4>');
            formattedText = formattedText.replace(/## (.*)/g, '<h3 class="text-2xl font-bold text-yellow-400 mt-6">$1</h3>');
            formattedText = formattedText.replace(/\* (.*)/g, '<li class="ml-4 list-disc">$1</li>');
            formattedText = formattedText.replace(/\n/g, '<br>'); // Converte i ritorni a capo
            
            // Aggiungo un wrapper <ul> se ci sono liste per migliorare la leggibilità
            if (formattedText.includes('<li')) {
                 // Rimuove <br> immediatamente prima e dopo <li>
                 formattedText = formattedText.replace(/<br><li/g, '<li');
                 formattedText = formattedText.replace(/<\/li><br>/g, '</li>');
                 
                 // Avvolge ogni blocco di <li> in <ul>
                 const listItems = formattedText.split('<li>');
                 if (listItems.length > 1) {
                     formattedText = listItems[0];
                     for (let i = 1; i < listItems.length; i++) {
                         formattedText += `<ul><li>${listItems[i]}</li></ul>`;
                     }
                     // Pulizia per doppie chiusure/aperture
                     formattedText = formattedText.replace(/<\/ul><ul>/g, '');
                 }
            }

            outputElement.innerHTML = formattedText;
        }

        /**
         * Gestisce il click sul pulsante di analisi.
         * Controlla che le due squadre selezionate non siano le stesse.
         */
        function handleAnalysisClick() {
            const team1Value = team1Select.value;
            const team2Value = team2Select.value;
            
            if (team1Value === team2Value) {
                showError("Per favore, seleziona due squadre diverse per l'analisi del match.");
                return;
            }
            
            generateAnalysis(team1Value, team2Value);
        }

    </script>

</body>
</html>
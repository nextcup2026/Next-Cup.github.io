<head>
    <meta http-equiv="Content-Security-Policy" content="default-src 'self' https://*.firebaseio.com https://*.googleapis.com; script-src 'self' 'unsafe-inline' 'unsafe-eval' https://cdn.tailwindcss.com https://*.gstatic.com https://*.googleapis.com https://*.firebaseio.com; style-src 'self' 'unsafe-inline' https://fonts.googleapis.com; font-src 'self' https://fonts.gstatic.com; img-src 'self' data: https://* blob:;">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NEXT CUP - Anteprima Match AI</title>

    <!-- Favicon -->
    <link rel="icon" type="image/png" href="favicon.png">
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Fonts: Inter + Orbitron (Tech) -->
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&family=Orbitron:wght@400;700;900&display=swap"
        rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #030712;
            color: #e5e7eb;
            overflow-x: hidden;
        }

        /* Background Grid Animation */
        .bg-grid {
            background-size: 50px 50px;
            background-image:
                linear-gradient(to right, rgba(59, 130, 246, 0.05) 1px, transparent 1px),
                linear-gradient(to bottom, rgba(59, 130, 246, 0.05) 1px, transparent 1px);
            mask-image: radial-gradient(circle at center, black 40%, transparent 100%);
        }

        .tech-font {
            font-family: 'Orbitron', sans-serif;
        }

        /* Glassmorphism Panel */
        .glass-panel {
            background: rgba(17, 24, 39, 0.7);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(59, 130, 246, 0.3);
            box-shadow: 0 0 40px rgba(59, 130, 246, 0.15), inset 0 0 20px rgba(59, 130, 246, 0.05);
        }

        /* Neon Text */
        .neon-text {
            color: #fff;
            text-shadow: 0 0 5px #3b82f6, 0 0 10px #3b82f6, 0 0 20px #2563eb;
        }

        .neon-text-gold {
            color: #fbbf24;
            text-shadow: 0 0 5px #fbbf24, 0 0 10px #d97706;
        }

        /* Button Glow */
        .btn-cyber {
            background: linear-gradient(90deg, #2563eb, #3b82f6);
            border: 1px solid #60a5fa;
            position: relative;
            overflow: hidden;
            transition: all 0.3s ease;
        }

        .btn-cyber:hover {
            transform: scale(1.05);
            box-shadow: 0 0 20px rgba(59, 130, 246, 0.6);
            border-color: #93c5fd;
        }

        .btn-cyber::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.4), transparent);
            transition: 0.5s;
        }

        .btn-cyber:hover::before {
            left: 100%;
        }

        /* Custom Select */
        .select-tech {
            background-color: rgba(31, 41, 55, 0.8);
            border: 1px solid rgba(75, 85, 99, 1);
            color: white;
            transition: all 0.3s;
        }

        .select-tech:focus {
            border-color: #3b82f6;
            box-shadow: 0 0 15px rgba(59, 130, 246, 0.4);
            outline: none;
        }

        /* Analysis Box Pulse */
        .analysis-box-container {
            position: relative;
        }

        .analysis-box-container::before {
            content: '';
            position: absolute;
            inset: -2px;
            background: linear-gradient(45deg, #3b82f6, #8b5cf6, #3b82f6);
            z-index: -1;
            filter: blur(10px);
            opacity: 0.5;
            animation: pulse-border 4s linear infinite;
        }

        @keyframes pulse-border {
            0% {
                opacity: 0.3;
            }

            50% {
                opacity: 0.7;
            }

            100% {
                opacity: 0.3;
            }
        }

        .hidden a {
            font-size: 18px;
        }
    </style>
</head>

<body class="antialiased">

    <!-- FIREBASE CONFIG -->
    <script>
        window.__firebase_config = JSON.stringify({
            apiKey: "AIzaSyDKkaydSHxKT20XzWKfS16H1d6TMNq4p5Q",
            authDomain: "torneo-585ac.firebaseapp.com",
            projectId: "torneo-585ac",
            storageBucket: "torneo-585ac.firebasestorage.app",
            messagingSenderId: "79275251686",
            appId: "1:79275251686:web:15ca08ce46b6ce5e4fa827",
            measurementId: "G-S2NZJJXKWW"
        });
        window.__app_id = "nextcup-app";  
    </script>

    <!-- Navbar (Consistent) -->
    <header class="sticky top-0 z-50 bg-gray-950/80 backdrop-blur border-b border-white/10">
        <nav class="max-w-7xl mx-auto px-6 py-4 flex justify-between items-center relative">
            <div class="flex items-center space-x-3">
                <img src="logo.png" alt="Logo torneo" class="w-12 h-12 rounded-full border border-gray-600">
                <a href="index.html" class="text-2xl font-black header-brand-text">
                    NEXT CUP
                </a>
            </div>

            <!-- DESKTOP MENU -->
            <div class="hidden md:flex space-x-8 font-semibold text-sm items-center">
                <a href="index.html" class="hover:text-yellow-400 transition">Home</a>

                <!-- DROPDOWN -->
                <div class="relative group">
                    <button class="flex items-center space-x-1 text-yellow-400 focus:outline-none py-4">
                        <span>Altro</span>
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7">
                            </path>
                        </svg>
                    </button>
                    <!-- Dropdown Menu -->
                    <div
                        class="absolute left-0 top-full w-48 bg-gray-900 border border-gray-700 rounded-xl shadow-2xl opacity-0 invisible group-hover:opacity-100 group-hover:visible transition-all duration-300 transform origin-top translate-y-2 group-hover:translate-y-0 z-50">
                        <div class="flex flex-col py-2">
                            <a href="teams.html"
                                class="px-4 py-3 text-white hover:bg-gray-800 hover:text-yellow-400 transition border-b border-gray-800 last:border-0">
                                Squadre
                            </a>
                            <a href="news.html"
                                class="px-4 py-3 text-white hover:bg-gray-800 hover:text-yellow-400 transition border-b border-gray-800 last:border-0">
                                Notizie
                            </a>
                            <a href="match_preview.html"
                                class="px-4 py-3 text-yellow-400 font-bold hover:bg-gray-800 transition border-b border-gray-800 last:border-0 relative">
                                Anteprima AI
                            </a>
                            <a href="torneo.html"
                                class="px-4 py-3 text-white hover:bg-gray-800 hover:text-yellow-400 transition border-b border-gray-800 last:border-0">
                                Torneo
                            </a>
                            <a href="statistics.html"
                                class="px-4 py-3 text-white hover:bg-gray-800 hover:text-yellow-400 transition border-b border-gray-800 last:border-0">
                                Statistiche
                            </a>
                            <a href="sondaggi.html"
                                class="px-4 py-3 text-white hover:bg-gray-800 hover:text-yellow-400 transition border-b border-gray-800 last:border-0">
                                Sondaggi
                            </a>
                        </div>
                    </div>
                </div>

                <a href="regolamento.html" class="hover:text-yellow-400 transition">Regolamento</a>
                <a href="contact.html" class="hover:text-yellow-400 transition">Contatti & Iscrizione</a>
            </div>

            <!-- MOBILE MENU BUTTON -->
            <div class="md:hidden flex items-center">
                <button id="mobile-menu-btn" class="text-white hover:text-yellow-400 focus:outline-none">
                    <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M4 6h16M4 12h16M4 18h16"></path>
                    </svg>
                </button>
            </div>
        </nav>

        <!-- MOBILE MENU DROPDOWN -->
        <div id="mobile-menu"
            class="hidden md:hidden bg-gray-900 border-t border-gray-800 absolute w-full left-0 top-full shadow-2xl z-50">
            <div class="flex flex-col px-6 py-4 space-y-4 font-semibold text-lg">
                <a href="index.html"
                    class="text-gray-300 hover:text-yellow-400 transition block border-b border-gray-800 pb-2">Home</a>
                <a href="teams.html"
                    class="text-gray-300 hover:text-yellow-400 transition block border-b border-gray-800 pb-2">Squadre</a>
                <a href="news.html"
                    class="text-gray-300 hover:text-yellow-400 transition block border-b border-gray-800 pb-2">Notizie</a>
                <a href="match_preview.html" class="text-yellow-400 block border-b border-gray-800 pb-2">Anteprima
                    AI</a>
                <a href="torneo.html"
                    class="text-gray-300 hover:text-yellow-400 transition block border-b border-gray-800 pb-2">Torneo</a>
                <a href="statistics.html"
                    class="text-gray-300 hover:text-yellow-400 transition block border-b border-gray-800 pb-2">Statistiche</a>
                <a href="sondaggi.html"
                    class="text-gray-300 hover:text-yellow-400 transition block border-b border-gray-800 pb-2">Sondaggi</a>
                <a href="regolamento.html"
                    class="text-gray-300 hover:text-yellow-400 transition block border-b border-gray-800 pb-2">Regolamento</a>
                <a href="contact.html" class="text-gray-300 hover:text-yellow-400 transition block">Contatti & Iscrizione</a>
            </div>
        </div>

        <script>
            const btn = document.getElementById('mobile-menu-btn');
            const menu = document.getElementById('mobile-menu');
            if (btn && menu) {
                btn.addEventListener('click', () => {
                    menu.classList.toggle('hidden');
                });
            }
        </script>
    </header>

    <!-- Main Content: AI Match Preview -->
    <section class="flex-grow py-16 px-4 sm:px-6 lg:px-8 relative z-10">
        <div class="max-w-5xl mx-auto">
            <div class="text-center mb-12">
                <h2 class="text-5xl md:text-7xl font-black tech-font neon-text mb-4 tracking-tight">AI PREDICTOR</h2>
                <div class="h-1 w-32 bg-blue-500 mx-auto rounded-full shadow-[0_0_15px_#3b82f6]"></div>
                <p class="mt-6 text-xl text-blue-200/80 max-w-2xl mx-auto">Algoritmo predittivo di nuova generazione per
                    l'analisi tattica delle partite.</p>
            </div>

            <!-- Match Setup -->
            <div class="glass-panel p-8 md:p-12 rounded-2xl mb-12 relative overflow-hidden">
                <!-- Decorative Elements -->
                <div
                    class="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-transparent via-blue-500 to-transparent opacity-50">
                </div>

                <h3
                    class="text-2xl font-bold text-white mb-10 text-center tech-font tracking-widest uppercase text-blue-300">
                    Configurazione Match</h3>

                <div
                    class="flex flex-col md:flex-row justify-around items-center space-y-8 md:space-y-0 text-center relative z-10">

                    <!-- Team 1 Selector -->
                    <div class="flex flex-col items-center w-full md:w-1/3 group">
                        <div class="relative mb-6">
                            <div
                                class="absolute inset-0 bg-blue-500 blur-xl opacity-20 group-hover:opacity-40 transition duration-500 rounded-full">
                            </div>
                            <img src="https://placehold.co/120x120/1e3a8a/FFD700?text=A" id="team1-logo"
                                alt="Logo Team 1"
                                class="w-32 h-32 rounded-full border-4 border-blue-500/50 shadow-2xl relative z-10 transition transform group-hover:scale-110">
                        </div>
                        <select id="team1" class="select-tech w-full p-3 rounded-lg font-semibold cursor-pointer">
                            <option value="Team Alpha Elite (Campioni in carica, forte attacco)"
                                data-logo="https://placehold.co/120x120/1e3a8a/FFD700?text=A">Team Alpha Elite</option>
                            <option value="FC Zenith (Finalista 2024, centrocampo di qualit√†)"
                                data-logo="https://placehold.co/120x120/374151/FFFFFF?text=Z">FC Zenith</option>
                            <option value="Red Devils J. (Giovani talenti, difesa solida)"
                                data-logo="https://placehold.co/120x120/dc2626/FFFFFF?text=R">Red Devils J.</option>
                            <option value="Accademy X (Sotto osservazione, incognita tattica)"
                                data-logo="https://placehold.co/120x120/4c4c4c/FFD700?text=X">Accademy X</option>
                            <option value="Green Lions (Velocit√† e contropiede)"
                                data-logo="https://placehold.co/120x120/059669/FFFFFF?text=G">Green Lions</option>
                            <option value="Blue Wave (Esperienza, gioco posizionale)"
                                data-logo="https://placehold.co/120x120/1e40af/FFFFFF?text=B">Blue Wave</option>
                            <option value="Virtus Calcio (Miglior difesa del torneo)"
                                data-logo="https://placehold.co/120x120/4f46e5/FFD700?text=V">Virtus Calcio</option>
                            <option value="Latina Power (Outsider, imprevedibile)"
                                data-logo="https://placehold.co/120x120/ef4444/FFFFFF?text=L">Latina Power</option>
                        </select>
                    </div>

                    <div
                        class="text-6xl font-black text-transparent bg-clip-text bg-gradient-to-br from-red-500 to-purple-600 tech-font animate-pulse px-4">
                        VS</div>

                    <!-- Team 2 Selector -->
                    <div class="flex flex-col items-center w-full md:w-1/3 group">
                        <div class="relative mb-6">
                            <div
                                class="absolute inset-0 bg-red-500 blur-xl opacity-20 group-hover:opacity-40 transition duration-500 rounded-full">
                            </div>
                            <img src="https://placehold.co/120x120/dc2626/FFFFFF?text=R" id="team2-logo"
                                alt="Logo Team 2"
                                class="w-32 h-32 rounded-full border-4 border-red-500/50 shadow-2xl relative z-10 transition transform group-hover:scale-110">
                        </div>
                        <select id="team2" class="select-tech w-full p-3 rounded-lg font-semibold cursor-pointer">
                            <option value="Red Devils J. (Giovani talenti, difesa solida)"
                                data-logo="https://placehold.co/120x120/dc2626/FFFFFF?text=R">Red Devils J.</option>
                            <option value="Team Alpha Elite (Campioni in carica, forte attacco)"
                                data-logo="https://placehold.co/120x120/1e3a8a/FFD700?text=A">Team Alpha Elite</option>
                            <option value="FC Zenith (Finalista 2024, centrocampo di qualit√†)"
                                data-logo="https://placehold.co/120x120/374151/FFFFFF?text=Z">FC Zenith</option>
                            <option value="Accademy X (Sotto osservazione, incognita tattica)"
                                data-logo="https://placehold.co/120x120/4c4c4c/FFD700?text=X">Accademy X</option>
                            <option value="Green Lions (Velocit√† e contropiede)"
                                data-logo="https://placehold.co/120x120/059669/FFFFFF?text=G">Green Lions</option>
                            <option value="Blue Wave (Esperienza, gioco posizionale)"
                                data-logo="https://placehold.co/120x120/1e40af/FFFFFF?text=B">Blue Wave</option>
                            <option value="Virtus Calcio (Miglior difesa del torneo)"
                                data-logo="https://placehold.co/120x120/4f46e5/FFD700?text=V">Virtus Calcio</option>
                            <option value="Latina Power (Outsider, imprevedibile)"
                                data-logo="https://placehold.co/120x120/ef4444/FFFFFF?text=L">Latina Power</option>
                        </select>
                    </div>
                </div>

                <div class="text-center mt-12">
                    <button id="analyze-button" onclick="handleAnalysisClick()"
                        class="btn-cyber text-white font-bold py-4 px-12 rounded-full text-xl shadow-[0_0_20px_rgba(37,99,235,0.5)] flex items-center justify-center mx-auto tech-font tracking-wider">
                        <span id="button-text">AVVIA SIMULAZIONE NO-LIMITS</span>
                    </button>
                    <p class="mt-4 text-xs text-blue-400 font-mono">POWERED BY GEMINI AI 2.5</p>
                </div>
            </div>

            <!-- AI Analysis Output -->
            <div class="analysis-box-container rounded-2xl glass-panel p-1">
                <div class="bg-gray-900/80 rounded-xl p-8 md:p-10 min-h-[300px]">
                    <h3
                        class="text-3xl font-bold neon-text-gold mb-8 pb-4 border-b border-gray-700 tech-font flex items-center gap-3">
                        <svg class="w-8 h-8 text-yellow-500 animate-spin-slow" fill="none" stroke="currentColor"
                            viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M13 10V3L4 14h7v7l9-11h-7z"></path>
                        </svg>
                        RISULTATI ANALISI
                    </h3>
                    <div id="analysis-output" class="text-gray-300 leading-relaxed font-mono text-lg">
                        <div class="flex flex-col items-center justify-center h-full text-blue-300/50 space-y-4 py-10">
                            <svg class="w-16 h-16 animate-pulse" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1"
                                    d="M9 3v2m6-2v2M9 19v2m6-2v2M5 9H3m2 6H3m18-6h-2m2 6h-2M7 19h10a2 2 0 002-2V7a2 2 0 00-2-2H7a2 2 0 00-2 2v10a2 2 0 002 2zM9 9h6v6H9V9z">
                                </path>
                            </svg>
                            <p>In attesa di input...</p>
                        </div>
                    </div>

                    <div id="sources-output" class="text-sm text-gray-500 mt-4 pt-4 border-t border-gray-800 hidden">
                    </div>
                </div>
            </div>

            <!-- Error Modal -->
            <div id="error-modal"
                class="fixed inset-0 bg-black/90 backdrop-blur-sm hidden items-center justify-center z-[100]"
                onclick="document.getElementById('error-modal').classList.add('hidden')">
                <div class="glass-panel p-8 rounded-xl shadow-2xl max-w-sm mx-auto border border-red-500/50 relative"
                    onclick="event.stopPropagation()">
                    <div class="absolute -top-3 -left-3 text-red-500 bg-black p-1 rounded-full border border-red-500">
                        <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                    </div>
                    <h4 class="text-2xl font-bold text-red-500 mb-4 tech-font tracking-wider">ERRORE DI SISTEMA</h4>
                    <p id="error-message" class="text-gray-300 font-mono text-sm mb-6">Si √® verificato un errore critico
                        durante la generazione dell'analisi.</p>
                    <button
                        class="w-full bg-red-600/20 hover:bg-red-600/40 text-red-400 border border-red-600/50 py-2 rounded transition"
                        onclick="document.getElementById('error-modal').classList.add('hidden')">Riavvia
                        Sistemi</button>
                </div>
            </div>

        </div>
    </section>

    <!-- Footer / Contatti (Consistent) -->
    <!-- FOOTER -->
    <footer class="bg-black py-10">
        <div
            class="max-w-7xl mx-auto flex flex-col md:flex-row justify-between items-center text-center md:text-left space-y-6 md:space-y-0">
            <div class="text-gray-400">
                <p class="text-lg font-bold nx-text-gradient mb-2">NEXT CUP</p>
                <p>&copy; 2026. Tutti i diritti riservati. Organizzato da Next Cup</p>
            </div>
            <div class="space-y-2">
                <p class="text-white font-semibold">Contattaci</p>
                <p class="text-sm text-gray-400">Email: <a href="mailto:nextcup2026@gmail.com"
                        class="hover:text-yellow-400">info@next-cup.it</a></p>
                <p class="text-sm text-gray-400">Luca: +39 351 508 6288</p>
                <p class="text-sm text-gray-400">Paolo: +39 320 216 5611</p>
            </div>
        </div>
    </footer>

    <!-- FIREBASE & LOGIC -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, collection, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- 1. CONFIGURAZIONE ---
        const firebaseConfig = JSON.parse(window.__firebase_config);
        const appId = window.__app_id;
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const TEAMS_PATH = `artifacts/${appId}/public/data/teams`;

        const apiKey = "AIzaSyAXtoc6LfwTK_oYtR1sGs-p-5MiyQj04hA"; // Chiave API Aggiornata
        const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;

        // --- 2. STATO & DOM ---
        let allTeams = []; // Ospiter√† i dati reali (id, name, players, logoUrl)

        const outputElement = document.getElementById('analysis-output');
        const buttonTextElement = document.getElementById('button-text');
        const analyzeButton = document.getElementById('analyze-button');
        const team1Select = document.getElementById('team1');
        const team2Select = document.getElementById('team2');
        const team1Logo = document.getElementById('team1-logo');
        const team2Logo = document.getElementById('team2-logo');
        const errorModal = document.getElementById('error-modal');
        const errorMessage = document.getElementById('error-message');

        // --- 3. FUNZIONI UI ---

        // Mostra Errore
        window.showError = (msg) => { // Esposto a global per onclick inline
            if (errorMessage && errorModal) {
                errorMessage.innerText = msg;
                errorModal.classList.remove('hidden');
                errorModal.classList.add('flex');
            } else {
                alert(msg);
            }
        };

        // Aggiorna Loghi
        const updateLogos = () => {
            const t1 = allTeams.find(t => t.id === team1Select.value);
            const t2 = allTeams.find(t => t.id === team2Select.value);

            if (t1) team1Logo.src = t1.logoUrl || "https://placehold.co/120x120/1e3a8a/FFD700?text=" + t1.name.charAt(0);
            if (t2) team2Logo.src = t2.logoUrl || "https://placehold.co/120x120/dc2626/FFFFFF?text=" + t2.name.charAt(0);
        };

        // Popola Select
        const renderSelectOptions = () => {
            if (allTeams.length === 0) return;

            // Svuota e riempi
            [team1Select, team2Select].forEach(select => {
                select.innerHTML = '';
                allTeams.forEach(team => {
                    const opt = document.createElement('option');
                    opt.value = team.id;
                    opt.textContent = team.name;
                    select.appendChild(opt);
                });
            });

            // Seleziona di default il primo e il secondo diverso
            if (allTeams.length > 1) {
                team2Select.selectedIndex = 1;
            }
            updateLogos();
        };

        // --- 4. DATA FETCHING ---
        const loadTeams = async () => {
            try {
                const querySnapshot = await getDocs(collection(db, TEAMS_PATH));
                allTeams = querySnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

                if (allTeams.length === 0) {
                    outputElement.innerHTML = "<p class='text-yellow-500'>Nessuna squadra trovata nel database. Aggiungile nella pagina Squadre.</p>";
                } else {
                    renderSelectOptions();
                }
            } catch (e) {
                console.error("Errore caricamento squadre:", e);
                window.showError("Impossibile caricare le squadre dal database.");
            }
        };

        // --- 5. LOGICA AI ---

        const delay = (ms) => new Promise(res => setTimeout(res, ms));

        // Costruisci il prompt con i dati VERI
        const buildPrompt = (team1Id, team2Id) => {
            const t1 = allTeams.find(t => t.id === team1Id);
            const t2 = allTeams.find(t => t.id === team2Id);

            // Estrai nomi giocatori
            const getPlayersList = (team) => {
                if (!team.players || !Array.isArray(team.players) || team.players.length === 0) return "Rosa non disponibile.";
                return team.players.map(p => {
                    if (typeof p === 'string') return p; // Vecchio formato
                    return `${p.name} (${p.role || 'G'})`; // Nuovo formato oggetto
                }).join(", ");
            };

            const t1Players = getPlayersList(t1);
            const t2Players = getPlayersList(t2);

            return `Analizza la partita di calcio giovanile Next Cup tra: **${t1.name}** vs **${t2.name}**.
            
            DATI SQUADRA 1 (${t1.name}):
            - Giocatori: ${t1Players}

            DATI SQUADRA 2 (${t2.name}):
            - Giocatori: ${t2Players}

            Fornisci un'analisi tecnica predittiva basandoti SU QUESTI GIOCATORI REALI (se presenti).
            Struttura:
            1. Punti di Forza e Debolezza (basati sulle caratteristiche note dei ruoli se presenti).
            2. Match-up Chiave (es. attaccante X vs difensore Y).
            3. Previsione del Risultato.
            Usa toni epici ma tecnici. Markdown richiesto.`;
        };

        const generateAnalysis = async () => {
            const t1Id = team1Select.value;
            const t2Id = team2Select.value;

            if (t1Id === t2Id) {
                window.showError("Seleziona due squadre diverse.");
                return;
            }

            // UI Loading
            analyzeButton.disabled = true;
            buttonTextElement.innerHTML = '<svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-white inline" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg> ELABORAZIONE DATI REALI...';
            outputElement.innerHTML = '<p class="text-center text-blue-300 animate-pulse">Accesso al Database... Estrazione statistiche... Generazione Analisi...</p>';

            const userQuery = buildPrompt(t1Id, t2Id);
            const systemPrompt = "Sei un analista tattico esperto della Next Cup.";

            const payload = {
                contents: [{ parts: [{ text: userQuery }] }],
                systemInstruction: { parts: [{ text: systemPrompt }] },
            };

            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) throw new Error(`Errore API: ${response.status}`);

                const result = await response.json();
                const text = result.candidates?.[0]?.content?.parts?.[0]?.text || "Errore nella generazione.";

                // Formattazione Finale
                let formatted = text
                    .replace(/### (.*)/g, '<h4 class="text-xl font-bold text-blue-400 mt-4 border-b border-blue-900/50 pb-1">$1</h4>')
                    .replace(/\*\* (.*) \*\*/g, '<span class="text-yellow-400 font-bold">$1</span>')
                    .replace(/\* (.*)/g, '<li class="ml-4 list-disc text-gray-300">$1</li>')
                    .replace(/\n/g, '<br>');

                outputElement.innerHTML = formatted;

            } catch (error) {
                console.error(error);
                window.showError("Errore durante l'analisi AI. Ritenta.");
                outputElement.innerHTML = "<p class='text-red-400 text-center'>Errore di connessione.</p>";
            } finally {
                analyzeButton.disabled = false;
                buttonTextElement.innerText = "AVVIA SIMULAZIONE NO-LIMITS";
            }
        };

        // Listeners
        if (team1Select && team2Select) {
            team1Select.addEventListener('change', updateLogos);
            team2Select.addEventListener('change', updateLogos);
        }

        // Espongo la funzione al pulsante onclick (che √® fuori dal modulo)
        window.handleAnalysisClick = generateAnalysis;

        // Init
        loadTeams();
    </script>


    <!-- COOKIE CONSENT BANNER -->
    <div id="cookie-banner" class="fixed bottom-0 left-0 right-0 bg-gray-900/95 backdrop-blur border-t border-gray-700 p-6 z-[200] transform transition-transform duration-500 translate-y-full" style="display: none;">
        <div class="max-w-7xl mx-auto flex flex-col md:flex-row items-center justify-between gap-4">
            <div class="text-gray-300 text-sm">
                <p class="font-bold text-white mb-1">üç™ Informativa Privacy</p>
                Questo sito utilizza cookie tecnici essenziali e strumenti di terze parti (Firebase) per il funzionamento. 
                Continuando a navigare, accetti l'utilizzo dei cookie.
            </div>
            <div class="flex space-x-4">
                <button onclick="acceptCookies()" class="bg-yellow-500 hover:bg-yellow-400 text-black font-bold py-2 px-6 rounded-lg transition">Accetta</button>
            </div>
        </div>
    </div>
    <script>
        function checkCookies() {
            if (!localStorage.getItem('cookieConsent')) {
                const banner = document.getElementById('cookie-banner');
                if(banner) {
                    banner.style.display = 'block';
                    setTimeout(() => banner.classList.remove('translate-y-full'), 100);
                }
            }
        }
        function acceptCookies() {
            localStorage.setItem('cookieConsent', 'true');
            const banner = document.getElementById('cookie-banner');
            if(banner) {
                banner.classList.add('translate-y-full');
                setTimeout(() => banner.style.display = 'none', 500);
            }
        }
        window.addEventListener('load', checkCookies);
    </script>

</body>

</html>
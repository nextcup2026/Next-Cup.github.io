<!DOCTYPE html>
<html lang="it">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NEXT CUP - Torneo</title>

    <link rel="icon" type="image/png" href="favicon.png">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;900&display=swap" rel="stylesheet">

    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #0d1a2f;
            color: #fff;
        }

        .nx-text-gradient {
            background: linear-gradient(45deg, #FFD700, #FBBF24, #3b82f6);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .tab-active {
            border-bottom: 2px solid #FBBF24;
            color: #FBBF24;
        }

        .hidden a {
            font-size: 18px;
        }
    </style>
</head>

<body class="antialiased min-h-screen flex flex-col">

    <!-- Navbar -->
    <header class="sticky top-0 z-50 bg-gray-950/80 backdrop-blur border-b border-white/10">
        <nav class="max-w-7xl mx-auto px-6 py-4 flex justify-between items-center relative">
            <div class="flex items-center space-x-3">
                <img src="logo.png" alt="Logo torneo" class="w-12 h-12 rounded-full border border-gray-600">
                <a href="index.html" class="text-2xl font-black nx-text-gradient">
                    NEXT CUP
                </a>
            </div>

            <!-- DESKTOP MENU -->
            <div class="hidden md:flex space-x-6 font-semibold text-sm">
                <a href="index.html" class="hover:text-yellow-400 transition">Home</a>
                <a href="teams.html" class="hover:text-yellow-400 transition">Squadre</a>
                <a href="news.html" class="hover:text-yellow-400 transition">Notizie</a>
                <a href="match_preview.html" class="hover:text-yellow-400 transition">Anteprima AI</a>
                <a href="torneo.html" class="text-yellow-400 transition">Torneo</a>
                <a href="statistics.html" class="hover:text-yellow-400 transition">Statistiche</a>
                <a href="sondaggi.html" class="hover:text-yellow-400 transition">Sondaggi</a>
                <a href="regolamento.html" class="hover:text-yellow-400 transition">Regolamento</a>
                <a href="contact.html" class="hover:text-yellow-400 transition">Contatti</a>
            </div>

            <!-- MOBILE MENU BUTTON -->
            <div class="md:hidden flex items-center">
                <button id="mobile-menu-btn" class="text-white hover:text-yellow-400 focus:outline-none">
                    <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M4 6h16M4 12h16M4 18h16"></path>
                    </svg>
                </button>
            </div>
        </nav>

        <!-- MOBILE MENU DROPDOWN -->
        <div id="mobile-menu"
            class="hidden md:hidden bg-gray-900 border-t border-gray-800 absolute w-full left-0 top-full shadow-2xl z-50">
            <div class="flex flex-col px-6 py-4 space-y-4 font-semibold text-lg">
                <a href="index.html"
                    class="text-gray-300 hover:text-yellow-400 transition block border-b border-gray-800 pb-2">Home</a>
                <a href="teams.html"
                    class="text-gray-300 hover:text-yellow-400 transition block border-b border-gray-800 pb-2">Squadre</a>
                <a href="news.html"
                    class="text-gray-300 hover:text-yellow-400 transition block border-b border-gray-800 pb-2">Notizie</a>
                <a href="match_preview.html"
                    class="text-gray-300 hover:text-yellow-400 transition block border-b border-gray-800 pb-2">Anteprima
                    AI</a>
                <a href="torneo.html" class="text-yellow-400 block border-b border-gray-800 pb-2">Torneo</a>
                <a href="statistics.html"
                    class="text-gray-300 hover:text-yellow-400 transition block border-b border-gray-800 pb-2">Statistiche</a>
                <a href="sondaggi.html"
                    class="text-gray-300 hover:text-yellow-400 transition block border-b border-gray-800 pb-2">Sondaggi</a>
                <a href="regolamento.html"
                    class="text-gray-300 hover:text-yellow-400 transition block border-b border-gray-800 pb-2">Regolamento</a>
                <a href="contact.html" class="text-gray-300 hover:text-yellow-400 transition block">Contatti</a>
            </div>
        </div>

        <script>
            const btn = document.getElementById('mobile-menu-btn');
            const menu = document.getElementById('mobile-menu');
            if (btn && menu) {
                btn.addEventListener('click', () => {
                    menu.classList.toggle('hidden');
                });
            }
        </script>
    </header>

    <main class="flex-grow py-12 px-4 max-w-7xl mx-auto w-full">
        <h1 class="text-5xl font-black text-center nx-text-gradient mb-12">STRUTTURA TORNEO</h1>

        <!-- Tabs -->
        <div class="flex justify-center space-x-8 mb-12 border-b border-gray-800">
            <button id="tab-groups" onclick="switchTab('groups')"
                class="pb-4 px-4 font-bold text-lg tab-active transition">Gironi</button>
            <button id="tab-calendar" onclick="switchTab('calendar')"
                class="pb-4 px-4 font-bold text-lg text-gray-400 hover:text-white transition">Calendario</button>
            <button id="tab-bracket" onclick="switchTab('bracket')"
                class="pb-4 px-4 font-bold text-lg text-gray-400 hover:text-white transition">Tabellone</button>
        </div>

        <!-- CONTENT: GIRONI -->
        <div id="content-groups" class="space-y-12 animate-fade-in">
            <!-- Will be populated by JS -->
            <div id="groups-container" class="grid grid-cols-1 md:grid-cols-2 gap-8">
                <p class="text-center col-span-full text-gray-500">Caricamento gironi...</p>
            </div>
        </div>

        <!-- CONTENT: CALENDARIO -->
        <div id="content-calendar" class="hidden">
            <div class="bg-gray-900 rounded-xl p-8 border border-gray-800 text-center">
                <p class="text-gray-400">Calendario in arrivo...</p>
            </div>
        </div>

        <!-- CONTENT: TABELLONE -->
        <div id="content-bracket" class="hidden">
            <div class="bg-gray-900 rounded-xl p-8 border border-gray-800 text-center">
                <p class="text-gray-400">Tabellone in arrivo...</p>
            </div>
        </div>

    </main>

    <!-- Footer -->
    <footer class="bg-black py-10 mt-auto">
        <div class="max-w-7xl mx-auto text-center text-gray-400">
            <p>&copy; 2026 NEXT CUP.</p>
        </div>
    </footer>

    <!-- FIREBASE CONFIG -->
    <script>
        window.__firebase_config = JSON.stringify({
            apiKey: "AIzaSyDKkaydSHxKT20XzWKfS16H1d6TMNq4p5Q",
            authDomain: "torneo-585ac.firebaseapp.com",
            projectId: "torneo-585ac",
            storageBucket: "torneo-585ac.firebasestorage.app",
            messagingSenderId: "79275251686",
            appId: "1:79275251686:web:15ca08ce46b6ce5e4fa827",
            measurementId: "G-S2NZJJXKWW"
        });
        window.__app_id = "nextcup-app";
    </script>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, collection, onSnapshot, query, orderBy } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const app = initializeApp(JSON.parse(window.__firebase_config));
        const db = getFirestore(app);
        const appId = window.__app_id;

        // UI Logic
        window.switchTab = (tab) => {
            document.querySelectorAll('[id^="content-"]').forEach(el => el.classList.add('hidden'));
            document.getElementById(`content-${tab}`).classList.remove('hidden');

            document.querySelectorAll('[id^="tab-"]').forEach(el => {
                el.classList.remove('tab-active', 'text-yellow-400');
                el.classList.add('text-gray-400');
            });
            const btn = document.getElementById(`tab-${tab}`);
            btn.classList.add('tab-active');
            btn.classList.remove('text-gray-400');
        };

        // Data Logic
        const teamsRef = collection(db, `artifacts/${appId}/public/data/teams`);
        const resultsRef = collection(db, `artifacts/${appId}/public/data/results`);
        const matchesRef = collection(db, `artifacts/${appId}/public/data/matches`);

        let teams = [];
        let results = [];
        let matches = [];

        function calculateStandings() {
            // Group teams by 'group' field
            const groups = {}; // { 'A': [team1, team2], 'B': ... }

            // Initialize stats for all teams
            const teamStats = {};
            teams.forEach(t => {
                const g = t.group || 'A'; // Default group A
                if (!groups[g]) groups[g] = [];

                // Initialize object if not exists
                if (!teamStats[t.name]) {
                    teamStats[t.name] = {
                        ...t,
                        played: 0, points: 0, gf: 0, ga: 0, dr: 0,
                        history: [] // Array to store 'W', 'D', 'L'
                    };
                } else {
                    teamStats[t.name] = { ...teamStats[t.name], ...t };
                }

                // Add to group list
                if (!groups[g].find(x => x.name === t.name)) {
                    groups[g].push(teamStats[t.name]);
                }
            });

            // Process results (Legacy)
            results.forEach(r => processMatchForStats(r, teamStats));

            // Process Live/Finished Matches from Calendar (New System)
            matches.forEach(m => {
                if (m.status === 'LIVE' || m.status === 'FINISHED') {
                    // Create a result-like object
                    const resultObj = {
                        team1: m.team1,
                        team2: m.team2,
                        score1: parseInt(m.score1 || 0),
                        score2: parseInt(m.score2 || 0)
                    };
                    processMatchForStats(resultObj, teamStats);
                }
            });

            renderGroups(groups);
            renderBracket();
        }

        function processMatchForStats(r, teamStats) {
            const t1 = teamStats[r.team1];
            const t2 = teamStats[r.team2];
            if (!t1 || !t2) return;

            t1.played++;
            t2.played++;
            t1.gf += r.score1;
            t1.ga += r.score2;
            t2.gf += r.score2;
            t2.ga += r.score1;
            t1.dr = t1.gf - t1.ga;
            t2.dr = t2.gf - t2.ga;

            if (r.score1 > r.score2) {
                t1.points += 3;
                t1.history.push('W');
                t2.history.push('L');
            } else if (r.score2 > r.score1) {
                t2.points += 3;
                t2.history.push('W');
                t1.history.push('L');
            } else {
                t1.points += 1;
                t2.points += 1;
                t1.history.push('D');
                t2.history.push('D');
            }
        }


        function renderGroups(groups) {
            const container = document.getElementById('groups-container');
            container.innerHTML = '';

            const sortedKeys = Object.keys(groups).sort();
            if (sortedKeys.length === 0) {
                container.innerHTML = '<p class="col-span-full text-center text-gray-500">Nessuna squadra trovata.</p>';
                return;
            }

            sortedKeys.forEach(groupName => {
                const groupTeams = groups[groupName].sort((a, b) => {
                    if (b.points !== a.points) return b.points - a.points;
                    return b.dr - a.dr;
                });

                const html = `
                    <div class="bg-gray-900 rounded-xl border border-gray-800 overflow-hidden shadow-xl">
                        <div class="bg-gray-800 px-6 py-4 border-b border-gray-700 flex justify-between items-center">
                            <h3 class="text-2xl font-bold text-yellow-400">GIRONE ${groupName}</h3>
                        </div>
                        <div class="overflow-x-auto">
                            <table class="w-full text-left border-collapse">
                                <thead>
                                    <tr class="text-gray-400 text-sm border-b border-gray-700">
                                        <th class="p-4 font-semibold">#</th>
                                        <th class="p-4 font-semibold">Squadra</th>
                                        <th class="p-4 font-semibold text-center hidden md:table-cell">Forma</th>
                                        <th class="p-4 font-semibold text-center">PT</th>
                                        <th class="p-4 font-semibold text-center">G</th>
                                        <th class="p-4 font-semibold text-center hidden sm:table-cell">DR</th>
                                    </tr>
                                </thead>
                                <tbody class="divide-y divide-gray-800">
                                    ${groupTeams.map((t, i) => {
                    // Form Visualization
                    const formBadges = t.history.slice(-5).reverse().map(res => {
                        if (res === 'W') return `<span class="inline-block w-6 h-6 rounded-full bg-green-500 text-black font-bold text-xs flex items-center justify-center" title="Vittoria">V</span>`;
                        if (res === 'D') return `<span class="inline-block w-6 h-6 rounded-full bg-gray-500 text-white font-bold text-xs flex items-center justify-center" title="Pareggio">N</span>`;
                        if (res === 'L') return `<span class="inline-block w-6 h-6 rounded-full bg-red-500 text-white font-bold text-xs flex items-center justify-center" title="Sconfitta">P</span>`;
                        return '';
                    }).join('<span class="w-1"></span>'); // spacer

                    return `
                                        <tr class="hover:bg-gray-800/50 transition">
                                            <td class="p-4 font-mono text-gray-500">${i + 1}</td>
                                            <td class="p-4 font-bold text-white flex items-center space-x-3">
                                                ${t.logoUrl ? `<img src="${t.logoUrl}" class="w-8 h-8 rounded-full bg-gray-700 object-cover border border-gray-600">` : ''}
                                                <span>${t.name}</span>
                                            </td>
                                            <td class="p-4 text-center hidden md:flex items-center justify-center min-h-[64px]">
                                                <div class="flex">${formBadges || '<span class="text-gray-600">-</span>'}</div>
                                            </td>
                                            <td class="p-4 text-center font-extrabold text-yellow-400 text-lg">${t.points}</td>
                                            <td class="p-4 text-center text-gray-400">${t.played}</td>
                                            <td class="p-4 text-center text-gray-500 hidden sm:table-cell">${t.dr > 0 ? '+' + t.dr : t.dr}</td>
                                        </tr>
                                    `}).join('')}
                                </tbody>
                            </table>
                        </div>
                    </div>
                `;
                container.insertAdjacentHTML('beforeend', html);
            });
        }

        function renderCalendar() {
            const container = document.getElementById('content-calendar');
            if (matches.length === 0) {
                container.innerHTML = `<div class="bg-gray-900 rounded-xl p-8 border border-gray-800 text-center"><p class="text-gray-400">Nessuna partita programmata al momento.</p></div>`;
                return;
            }

            // Sort: Live (top), then Scheduled/Finished by date
            const sortedMatches = matches.sort((a, b) => {
                if (a.status === 'LIVE' && b.status !== 'LIVE') return -1;
                if (b.status === 'LIVE' && a.status !== 'LIVE') return 1;
                return (a.timestamp || '').localeCompare(b.timestamp || '');
            });

            const html = `
                <div class="max-w-4xl mx-auto space-y-6">
                    ${sortedMatches.map(m => {
                const isLive = m.status === 'LIVE';
                const isFinished = m.status === 'FINISHED';
                const scoreDisplay = isLive || isFinished
                    ? `<div class="bg-gray-800 px-4 py-2 rounded-lg text-white font-mono font-bold text-2xl border border-gray-700 mx-4 shadow-inner flex items-center justify-center min-w-[100px]">
                                <span class="text-yellow-400">${m.score1 || 0}</span>
                                <span class="mx-2 text-gray-500">-</span>
                                <span class="text-yellow-400">${m.score2 || 0}</span>
                               </div>`
                    : `<div class="bg-gray-800 px-3 py-1 rounded text-gray-500 font-mono font-bold">VS</div>`;

                const statusBadge = isLive
                    ? `<span class="bg-green-500 text-black text-xs font-bold px-3 py-1 rounded-full animate-pulse border border-green-400 shadow-[0_0_10px_rgba(34,197,94,0.5)]">● LIVE</span>`
                    : (isFinished ? `<span class="bg-gray-700 text-gray-300 text-xs px-2 py-1 rounded border border-gray-600">FINALE</span>` : `<span class="bg-gray-800 text-gray-400 text-xs px-2 py-1 rounded border border-gray-700">IN PROGRAMMA</span>`);

                const scorersHtml = (m.scorers && m.scorers.length > 0) ? `
                            <div class="mt-4 pt-4 border-t border-gray-800 w-full text-sm text-gray-400">
                                <div class="flex flex-wrap justify-center gap-4">
                                     ${m.scorers.map(s => `<span><span class="text-yellow-500 font-bold">${s.minute}'</span> ${s.player} (${s.team})</span>`).join('<span class="text-gray-700 mx-2">•</span>')}
                                </div>
                            </div>
                        ` : '';

                return `
                        <div class="bg-gray-900 rounded-xl p-6 border-l-4 ${isLive ? 'border-green-500 shadow-[0_0_15px_rgba(34,197,94,0.15)] ring-1 ring-green-900' : 'border-yellow-400 shadow-lg'} flex flex-col items-center justify-between transition-all duration-300 hover:bg-gray-800/50">
                            <div class="w-full flex flex-col md:flex-row items-center justify-between gap-4 mb-2">
                                 <div class="text-center md:text-left">
                                    <p class="text-purple-400 font-bold text-sm tracking-widest uppercase mb-1 flex items-center justify-center md:justify-start gap-2">
                                        ${statusBadge}
                                        <span>${m.stage}</span>
                                    </p>
                                    <p class="text-lg font-bold text-gray-300 text-center md:text-left">${new Date(m.date).toLocaleDateString('it-IT')} - ${m.time}</p>
                                </div>
                                
                                <div class="flex items-center justify-center w-full md:w-auto flex-1 max-w-lg">
                                    <div class="text-right flex-1">
                                        <span class="text-xl md:text-3xl font-black text-white block leading-tight">${m.team1}</span>
                                    </div>
                                    ${scoreDisplay}
                                    <div class="text-left flex-1">
                                        <span class="text-xl md:text-3xl font-black text-white block leading-tight">${m.team2}</span>
                                    </div>
                                </div>
                            </div>
                            ${scorersHtml}
                        </div>
                    `}).join('')}
                </div>
            `;
            container.innerHTML = html;
        }

        function renderBracket() {
            // Visualize bracket based on Results + Scheduled matches filtered by Stage (Quarti, Semi, Finale)
            const stages = ['Ottavi', 'Quarti', 'Semifinale', 'Finale'];
            const container = document.getElementById('content-bracket');

            // Combine results and matches
            // We assume 'results' collection might not have 'stage' field unless we add it. 
            // Currently Results don't have 'stage'. 
            // Ideally we should have migrated them or simply check matches 'scheduled' vs 'finished'.
            // For now, let's just list the "Scheduled" Knockout matches from the Calendar

            const knockoutMatches = matches.filter(m => stages.includes(m.stage));

            if (knockoutMatches.length === 0) {
                container.innerHTML = `<div class="bg-gray-900 rounded-xl p-8 border border-gray-800 text-center"><p class="text-gray-400">Il tabellone sarà disponibile quando verranno programmate le fasi finali.</p></div>`;
                return;
            }

            container.innerHTML = `<div class="grid grid-cols-1 md:grid-cols-2 gap-6 max-w-5xl mx-auto">
                ${knockoutMatches.map(m => `
                    <div class="bg-gray-900 p-6 rounded-xl border border-blue-500/30 relative overflow-hidden">
                        <div class="absolute top-0 right-0 bg-blue-600 text-white text-xs font-bold px-2 py-1 rounded-bl-lg">${m.stage}</div>
                        <div class="flex justify-between items-center mt-2">
                             <div class="font-bold text-lg">${m.team1}</div>
                             <div class="text-gray-500 text-sm">vs</div>
                             <div class="font-bold text-lg">${m.team2}</div>
                        </div>
                        <div class="text-center mt-4 text-sm text-gray-400 font-mono">${m.date} ${m.time}</div>
                    </div>
                `).join('')}
            </div>`;
        }

        // Listeners
        onSnapshot(teamsRef, snap => {
            teams = snap.docs.map(d => d.data());
            if (results.length > 0 || teams.length > 0) calculateStandings();
        });

        onSnapshot(resultsRef, snap => {
            results = snap.docs.map(d => d.data());
            if (teams.length > 0) calculateStandings();
        });

        onSnapshot(matchesRef, snap => {
            matches = snap.docs.map(d => d.data());
            renderCalendar();
            renderBracket();
        });

    </script>
</body>

</html>